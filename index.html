<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineStream - Premium Entertainment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            --glass: rgba(18, 18, 26, 0.8);
            --glass-border: rgba(255, 255, 255, 0.08);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.47059;
            font-weight: 400;
            letter-spacing: -0.022em;
            overflow-x: hidden;
        }

        /* Ambient Background */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .light-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.15;
            animation: float 20s infinite ease-in-out;
        }

        .light-orb:nth-child(1) {
            width: 600px;
            height: 600px;
            background: var(--accent);
            top: -300px;
            right: -200px;
            animation-delay: 0s;
        }

        .light-orb:nth-child(2) {
            width: 400px;
            height: 400px;
            background: var(--accent-secondary);
            bottom: -200px;
            left: -100px;
            animation-delay: -5s;
        }

        .light-orb:nth-child(3) {
            width: 300px;
            height: 300px;
            background: #ec4899;
            top: 50%;
            left: 50%;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -50px) scale(1.1); }
            50% { transform: translate(-30px, 30px) scale(0.9); }
            75% { transform: translate(20px, 20px) scale(1.05); }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 3px solid transparent;
        }

        .loading-spinner::before {
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }

        .loading-spinner::after {
            border-right-color: var(--accent-secondary);
            animation: spin 1.5s linear infinite reverse;
        }

        .loading-text {
            margin-top: 24px;
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 16px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            min-width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: var(--success); }
        .toast.error .toast-icon { background: var(--error); }
        .toast.warning .toast-icon { background: var(--warning); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* GUI Modal */
        .gui-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            z-index: 6000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gui-modal.active {
            display: flex;
            opacity: 1;
        }

        .gui-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 40px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--glass-border);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 40px 80px rgba(0,0,0,0.5);
        }

        .gui-modal.active .gui-content {
            transform: scale(1) translateY(0);
        }

        .gui-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .gui-icon.success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .gui-icon.error { background: rgba(239, 68, 68, 0.15); color: var(--error); }
        .gui-icon.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .gui-icon.confirm { background: rgba(99, 102, 241, 0.15); color: var(--accent); }

        .gui-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .gui-message {
            color: var(--text-secondary);
            margin-bottom: 28px;
            line-height: 1.6;
            font-size: 15px;
        }

        .gui-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .gui-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gui-btn-primary {
            background: var(--accent);
            color: white;
        }

        .gui-btn-primary:hover {
            background: #5558e3;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .gui-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .gui-btn-secondary:hover {
            background: var(--glass-border);
        }

        /* Navigation */
        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 16px 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-container.scrolled {
            background: var(--glass);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.021em;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            inset: -10px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .logo:hover::after {
            opacity: 1;
        }

        .logo.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .nav-links {
            display: flex;
            gap: 32px;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text-primary);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            width: 100%;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Search Bar */
        .search-container {
            position: relative;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: 100px;
            padding: 10px 16px;
            width: 280px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .search-bar:focus-within {
            border-color: var(--accent);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-btn {
            width: 20px;
            height: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.3s ease;
        }

        .search-bar:focus-within .search-btn {
            color: var(--accent);
        }

        .search-bar input {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            width: 100%;
            margin-left: 10px;
        }

        .search-bar input::placeholder {
            color: var(--text-tertiary);
        }

        /* Search Suggestions - FIXED LAYOUT */
        .search-suggestions {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 420px;
            max-height: 520px;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .suggestion-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--glass-border);
        }

        .suggestion-item:hover {
            background: var(--bg-tertiary);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-thumb {
            width: 48px;
            height: 72px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-tertiary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .suggestion-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .suggestion-info {
            flex: 1;
            min-width: 0;
        }

        .suggestion-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .suggestion-meta {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggestion-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #fbbf24;
            font-weight: 600;
        }

        .suggestion-type {
            padding: 4px 10px;
            background: var(--accent);
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            padding: 2px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .user-avatar:hover::after {
            opacity: 1;
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 1;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hero Section */
        .hero {
            position: relative;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            padding: 0 0 140px;
        }

        .hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        .hero-bg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
        }

        .hero-gradient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                rgba(10, 10, 15, 0.3) 0%, 
                rgba(10, 10, 15, 0.6) 50%,
                var(--bg-primary) 100%);
            z-index: -1;
        }

        .hero-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 48px;
            width: 100%;
            z-index: 2;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 10px 18px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 24px;
            border: 1px solid var(--glass-border);
            color: var(--accent);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .hero-title {
            font-size: 72px;
            font-weight: 800;
            line-height: 1.05;
            letter-spacing: -0.02em;
            margin-bottom: 20px;
            max-width: 800px;
            background: linear-gradient(135deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .hero-meta .rating {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #fbbf24;
            font-weight: 700;
            background: rgba(251, 191, 36, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .hero-meta .year {
            font-weight: 600;
            color: var(--text-primary);
        }

        .hero-description {
            font-size: 19px;
            line-height: 1.5;
            color: var(--text-secondary);
            max-width: 600px;
            margin-bottom: 32px;
        }

        .hero-actions {
            display: flex;
            gap: 16px;
        }

        .btn {
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            background: #5558e3;
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--glass);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
        }

        /* Continue Watching Banner */
        .continue-banner {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .continue-banner::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .continue-banner:hover::before {
            transform: translateX(100%);
        }

        .continue-banner:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            transform: translateX(8px);
            border-color: var(--accent);
        }

        .continue-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .continue-thumb {
            width: 80px;
            height: 45px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .continue-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .continue-text h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .continue-text p {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .continue-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .continue-banner:hover .continue-btn {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.4);
        }

        /* Content Sections */
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 48px;
            margin-top: -80px;
            position: relative;
            z-index: 10;
        }

        .page-content {
            padding-top: 100px;
            min-height: 100vh;
        }

        .section {
            margin-bottom: 80px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--accent), var(--accent-secondary));
            border-radius: 2px;
        }

        .see-all {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: none;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
        }

        .see-all:hover {
            color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
            gap: 10px;
        }

        /* Top 10 Section */
        .top-10-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 16px;
        }

        .top-10-card {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .top-10-card:hover {
            transform: translateY(-8px);
        }

        .top-10-number {
            position: absolute;
            bottom: -20px;
            left: -10px;
            font-size: 120px;
            font-weight: 900;
            line-height: 1;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.3;
            z-index: 1;
            pointer-events: none;
            font-family: 'SF Pro Display', -apple-system, sans-serif;
        }

        .top-10-image {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 2/3;
            z-index: 2;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .top-10-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .top-10-card:hover .top-10-image img {
            transform: scale(1.05);
        }

        @media (max-width: 1400px) {
            .top-10-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 768px) {
            .top-10-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .top-10-number {
                font-size: 80px;
                bottom: -15px;
                left: -5px;
            }
        }

        /* Movie Grid */
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 24px;
        }

        .movie-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-secondary);
            aspect-ratio: 2/3;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .movie-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 30px rgba(99, 102, 241, 0.1);
            z-index: 10;
        }

        .movie-card.completed {
            opacity: 0.8;
        }

        .completed-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .movie-card.completed .completed-badge {
            opacity: 1;
        }

        .add-to-list-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            z-index: 15;
            font-size: 18px;
            font-weight: 700;
        }

        .movie-card:hover .add-to-list-btn {
            opacity: 1;
            transform: scale(1);
        }

        .add-to-list-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .add-to-list-btn.in-list {
            background: var(--success);
            opacity: 1;
            transform: scale(1);
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.1);
            z-index: 5;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .movie-card:hover img {
            transform: scale(1.1);
        }

        .movie-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, 
                rgba(10, 10, 15, 0.95) 0%, 
                rgba(10, 10, 15, 0.7) 40%,
                transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
        }

        .movie-card:hover .movie-overlay {
            opacity: 1;
        }

        .movie-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .movie-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .movie-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #fbbf24;
            font-weight: 700;
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 64px;
            height: 64px;
            background: rgba(99, 102, 241, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
        }

        .play-icon svg {
            width: 28px;
            height: 28px;
            margin-left: 4px;
            fill: white;
        }

        .movie-card:hover .play-icon {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .remove-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .movie-card:hover .remove-btn {
            opacity: 1;
        }

        .remove-btn:hover {
            transform: scale(1.1);
            background: var(--error);
        }

        /* Featured Grid */
        .featured-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .featured-large {
            grid-row: span 2;
        }

        .featured-card {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            aspect-ratio: 16/9;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .featured-card.featured-large {
            aspect-ratio: auto;
            height: 100%;
        }

        .featured-card:hover {
            transform: scale(1.02);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(99, 102, 241, 0.1);
        }

        .featured-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .featured-card:hover img {
            transform: scale(1.05);
        }

        .featured-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 32px;
            background: linear-gradient(to top, rgba(10, 10, 15, 0.95), transparent);
        }

        .featured-tag {
            display: inline-block;
            padding: 8px 16px;
            background: var(--accent);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .featured-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        .featured-card.small .featured-title {
            font-size: 20px;
        }

        .featured-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 24px;
        }

        /* Filters and Sort */
        .filters-container {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-filter-bar {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-filter-bar input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-filter-bar input:focus {
            border-color: var(--accent);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-filter-bar svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
        }

        .sort-dropdown {
            position: relative;
        }

        .sort-btn {
            padding: 14px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .sort-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 8px;
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .sort-dropdown.active .sort-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .sort-option {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sort-option:hover {
            background: var(--bg-tertiary);
        }

        .sort-option.active {
            color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .genre-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .genre-chip {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .genre-chip:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
        }

        .genre-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Search Results Page */
        .search-header {
            margin-bottom: 40px;
        }

        .search-header h2 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 800;
        }

        .search-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .results-count {
            color: var(--accent);
            font-weight: 700;
        }

        /* Infinite Scroll Loading */
        .infinite-scroll-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            gap: 12px;
        }

        .infinite-scroll-loader.hidden {
            display: none;
        }

        .loader-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Episode Selector */
        .episode-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .episode-modal.active {
            display: flex;
            opacity: 1;
        }

        .episode-container {
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            margin: auto;
            background: var(--bg-secondary);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--glass-border);
            box-shadow: 0 40px 80px rgba(0,0,0,0.5);
        }

        .episode-header {
            padding: 32px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .episode-show-info h2 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .episode-show-info p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .close-episodes {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-episodes:hover {
            background: var(--accent);
            transform: rotate(90deg);
        }

        .episode-content {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .season-sidebar {
            width: 280px;
            border-right: 1px solid var(--glass-border);
            padding: 24px;
            overflow-y: auto;
        }

        .season-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 16px;
            letter-spacing: 0.1em;
        }

        .season-btn {
            width: 100%;
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .season-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .season-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .episode-list {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .episode-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            border: 1px solid transparent;
        }

        .episode-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--glass-border);
        }

        .episode-item.watched {
            opacity: 0.5;
        }

        .episode-item.watched::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--success);
            border-radius: 2px;
        }

        .episode-item.current {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent);
        }

        .episode-thumb {
            width: 160px;
            height: 90px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            background: var(--bg-tertiary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .episode-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .episode-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .episode-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .episode-number {
            font-size: 13px;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .episode-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .episode-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .episode-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
            color: var(--success);
            font-weight: 600;
        }

        .watched-icon {
            width: 16px;
            height: 16px;
        }

        /* Video Modal */
        .video-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.98);
            backdrop-filter: blur(30px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-modal.active {
            display: flex;
            opacity: 1;
        }

        .video-container {
            width: 95%;
            max-width: 1600px;
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            background: #000;
            border: 1px solid var(--glass-border);
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-controls {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* Top 50 Page Specific */
        .top50-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 24px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            nav, .hero-content, .content-wrapper { padding-left: 24px; padding-right: 24px; }
            .hero-title { font-size: 56px; }
            .featured-grid { grid-template-columns: 1fr 1fr; }
            .featured-large { grid-row: span 1; }
            .search-suggestions { width: 100%; right: 0; }
            .filters-container { flex-direction: column; align-items: stretch; }
            .search-filter-bar { min-width: 100%; }
            .search-bar { width: 240px; }
        }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hero-title { font-size: 40px; }
            .hero { padding-bottom: 100px; }
            .movie-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .featured-grid { grid-template-columns: 1fr; }
            .section-title { font-size: 20px; }
            .episode-content { flex-direction: column; }
            .season-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--glass-border); }
            .search-bar { width: 200px; }
            .toast-container { left: 16px; right: 16px; bottom: 16px; }
            .toast { min-width: auto; width: 100%; }
            .genre-filter { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 8px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Pulse animation for live indicator */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }

        .live-dot::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid var(--success);
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>
<body>

    <!-- Ambient Background -->
    <div class="ambient-light">
        <div class="light-orb"></div>
        <div class="light-orb"></div>
        <div class="light-orb"></div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading CineStream...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- GUI Modal -->
    <div class="gui-modal" id="guiModal">
        <div class="gui-content">
            <div class="gui-icon" id="guiIcon"></div>
            <h3 class="gui-title" id="guiTitle">Title</h3>
            <p class="gui-message" id="guiMessage">Message</p>
            <div class="gui-buttons" id="guiButtons">
                <button class="gui-btn gui-btn-primary" onclick="closeGuiModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-container" id="navContainer">
        <nav>
            <a class="logo" id="navLogo" onclick="router('home')">CineStream</a>
            <ul class="nav-links">
                <li>
                    <a onclick="router('home')" id="nav-home" class="active">
                        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                        Home
                    </a>
                </li>
                <li>
                    <a onclick="router('movies')" id="nav-movies">
                        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>
                        Movies
                    </a>
                </li>
                <li>
                    <a onclick="router('tv')" id="nav-tv">
                        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                        TV Shows
                    </a>
                </li>
                <li>
                    <a onclick="router('mylist')" id="nav-mylist">
                        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        My List
                    </a>
                </li>
            </ul>
            <div class="nav-actions">
                <div class="search-container">
                    <div class="search-bar" id="searchBar">
                        <button class="search-btn">
                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        </button>
                        <input type="text" id="searchInput" placeholder="Search movies, shows..." oninput="handleSearchInput(this.value)" onkeydown="handleSearchKey(event)" onfocus="showSearchHistory()">
                    </div>
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>
                <div class="user-avatar">CS</div>
            </div>
        </nav>
    </div>

    <!-- HOME PAGE -->
    <div class="page active" id="page-home">
        <section class="hero" id="hero">
            <div class="hero-bg" id="heroBg">
                <img src="" alt="Hero Background">
            </div>
            <div class="hero-gradient"></div>
            <div class="hero-content">
                <div class="hero-badge">
                    <span class="live-dot"></span>
                    Now Streaming
                </div>
                <h1 class="hero-title" id="heroTitle">CineStream</h1>
                <div class="hero-meta" id="heroMeta">
                    <span class="rating">
                        <svg style="width: 18px; height: 18px; fill: currentColor;" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        <span id="heroRating">--</span>
                    </span>
                    <span class="year" id="heroYear">----</span>
                    <span id="heroGenre">Loading...</span>
                    <span></span>
                    <span id="heroDuration">--</span>
                </div>
                <p class="hero-description" id="heroDesc">
                    Experience cinema like never before with our premium collection of films and series.
                </p>
                <div class="hero-actions">
                    <button class="btn btn-primary" onclick="playHero()">
                        <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        Play Now
                    </button>
                    <button class="btn btn-secondary" onclick="addHeroToList()">
                        <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        My List
                    </button>
                </div>
            </div>
        </section>

        <div class="content-wrapper">
            <!-- Continue Watching -->
            <div id="continueWatchingContainer" style="display: none;"></div>

            <!-- Watch It Again -->
            <section class="section" id="watchItAgainSection" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Watch It Again</h2>
                    <button class="see-all" onclick="clearWatchHistory()">Clear History</button>
                </div>
                <div class="movie-grid" id="watchItAgainGrid"></div>
            </section>

            <!-- Top 10 Movies -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Top 10 Movies</h2>
                    <button class="see-all" onclick="router('movies')">View All</button>
                </div>
                <div class="top-10-grid" id="top10MoviesGrid"></div>
            </section>

            <!-- Top 10 TV Shows -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Top 10 TV Shows</h2>
                    <button class="see-all" onclick="router('tv')">View All</button>
                </div>
                <div class="top-10-grid" id="top10TVGrid"></div>
            </section>

            <!-- New Releases - Now shows 4 items with See All -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">New Releases</h2>
                    <button class="see-all" onclick="router('top50')">See All</button>
                </div>
                <div class="movie-grid" id="newReleasesGrid"></div>
            </section>

            <!-- Trending Now - Now shows 4 items with See All -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Trending Now</h2>
                    <button class="see-all" onclick="router('top50')">See All</button>
                </div>
                <div class="movie-grid" id="trendingGrid"></div>
            </section>

            <!-- Popular Series - Now shows 4 items with See All -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Popular Series</h2>
                    <button class="see-all" onclick="router('tv')">See All</button>
                </div>
                <div class="movie-grid" id="popularGrid"></div>
            </section>

            <!-- Recommended For You - Now shows 4 items with See All -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Recommended For You</h2>
                    <button class="see-all" onclick="router('top50')">
                        <svg style="width: 16px; height: 16px; fill: currentColor; transform: rotate(0deg); transition: transform 0.3s;" id="refreshIcon" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        See All
                    </button>
                </div>
                <div class="movie-grid" id="recommendedGrid"></div>
            </section>
        </div>
    </div>

    <!-- SEARCH RESULTS PAGE -->
    <div class="page" id="page-search">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="search-header">
                    <h2>Search Results</h2>
                    <p>Found <span class="results-count" id="searchResultsCount">0</span> results for "<span id="searchQueryDisplay"></span>"</p>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="searchResultsInput" placeholder="Refine your search..." oninput="filterSearchResults(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="sortDropdown">
                        <button class="sort-btn" onclick="toggleSortDropdown()">
                            <span id="currentSort">Sort by: Popularity</span>
                            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortResults('popularity', 'Popularity')">Popularity</div>
                            <div class="sort-option" onclick="sortResults('rating', 'Rating (High to Low)')">Rating (High to Low)</div>
                            <div class="sort-option" onclick="sortResults('date_new', 'Date (Newest)')">Date (Newest)</div>
                            <div class="sort-option" onclick="sortResults('date_old', 'Date (Oldest)')">Date (Oldest)</div>
                            <div class="sort-option" onclick="sortResults('title_az', 'Title (A-Z)')">Title (A-Z)</div>
                            <div class="sort-option" onclick="sortResults('title_za', 'Title (Z-A)')">Title (Z-A)</div>
                        </div>
                    </div>
                </div>

                <div class="genre-filter" id="searchGenreFilter">
                    <div class="genre-chip active" onclick="filterByGenre('all')">All</div>
                    <div class="genre-chip" onclick="filterByGenre(28)">Action</div>
                    <div class="genre-chip" onclick="filterByGenre(35)">Comedy</div>
                    <div class="genre-chip" onclick="filterByGenre(18)">Drama</div>
                    <div class="genre-chip" onclick="filterByGenre(27)">Horror</div>
                    <div class="genre-chip" onclick="filterByGenre(10749)">Romance</div>
                    <div class="genre-chip" onclick="filterByGenre(878)">Sci-Fi</div>
                    <div class="genre-chip" onclick="filterByGenre(53)">Thriller</div>
                </div>

                <div class="movie-grid" id="searchResultsGrid"></div>
                
                <div id="noSearchResults" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <h2>No results found</h2>
                    <p>Try adjusting your search or filters</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MOVIES PAGE -->
    <div class="page" id="page-movies">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 32px;">
                    <h2 class="section-title">All Movies</h2>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="moviesSearchInput" placeholder="Search movies..." oninput="filterMovies(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="moviesSortDropdown">
                        <button class="sort-btn" onclick="toggleMoviesSort()">
                            <span id="moviesCurrentSort">Sort by: Popularity</span>
                            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortMovies('popular')">Popularity</div>
                            <div class="sort-option" onclick="sortMovies('rating')">Highest Rated</div>
                            <div class="sort-option" onclick="sortMovies('latest')">Latest</div>
                            <div class="sort-option" onclick="sortMovies('title_az')">A-Z</div>
                        </div>
                    </div>
                </div>

                <div class="movie-grid" id="allMoviesGrid"></div>
                <div class="infinite-scroll-loader hidden" id="moviesLoader">
                    <div class="loader-spinner"></div>
                    <span class="loader-text">Loading more movies...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- TV SHOWS PAGE -->
    <div class="page" id="page-tv">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 32px;">
                    <h2 class="section-title">All TV Shows</h2>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="tvSearchInput" placeholder="Search TV shows..." oninput="filterTV(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="tvSortDropdown">
                        <button class="sort-btn" onclick="toggleTVSort()">
                            <span id="tvCurrentSort">Sort by: Popularity</span>
                            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortTV('popular')">Popularity</div>
                            <div class="sort-option" onclick="sortTV('rating')">Highest Rated</div>
                            <div class="sort-option" onclick="sortTV('latest')">Latest</div>
                            <div class="sort-option" onclick="sortTV('title_az')">A-Z</div>
                        </div>
                    </div>
                </div>

                <div class="movie-grid" id="allTVGrid"></div>
                <div class="infinite-scroll-loader hidden" id="tvLoader">
                    <div class="loader-spinner"></div>
                    <span class="loader-text">Loading more shows...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- TOP 50 PAGE - New dedicated page for IMDb Top 50 -->
    <div class="page" id="page-top50">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 32px;">
                    <h2 class="section-title">Top 50 Movies</h2>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Top rated movies according to IMDb</p>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="top50SearchInput" placeholder="Search top 50 movies..." oninput="filterTop50(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="top50SortDropdown">
                        <button class="sort-btn" onclick="toggleTop50Sort()">
                            <span id="top50CurrentSort">Sort by: IMDb Rating</span>
                            <svg style="width: 16px; height: 16px; fill: currentColor;" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortTop50('rating')">IMDb Rating</div>
                            <div class="sort-option" onclick="sortTop50('popular')">Popularity</div>
                            <div class="sort-option" onclick="sortTop50('latest')">Latest</div>
                            <div class="sort-option" onclick="sortTop50('title_az')">A-Z</div>
                        </div>
                    </div>
                </div>

                <div class="top50-grid movie-grid" id="top50Grid"></div>
                <div class="infinite-scroll-loader hidden" id="top50Loader">
                    <div class="loader-spinner"></div>
                    <span class="loader-text">Loading more movies...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MY LIST PAGE -->
    <div class="page" id="page-mylist">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title">My List</h2>
                    <button class="see-all btn-danger" onclick="clearMyList()" id="clearListBtn" style="display: none;">
                        <svg style="width: 16px; height: 16px; fill: currentColor; margin-right: 6px;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        Clear All
                    </button>
                </div>
                
                <div id="myListGrid" class="movie-grid"></div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    <h2>Your list is empty</h2>
                    <p>Movies and shows you add will appear here</p>
                    <button class="btn btn-primary" onclick="router('home')" style="margin-top: 24px;">Browse Content</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-container">
            <div class="video-controls">
                <button class="control-btn" onclick="toggleEpisodeSelector()" title="Episodes" id="episodesBtn" style="display: none;">
                    <svg style="width: 24px; height: 24px; fill: currentColor;" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z"/></svg>
                </button>
                <button class="control-btn" onclick="closeVideo()">
                    <svg style="width: 24px; height: 24px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="video-wrapper" id="videoWrapper"></div>
        </div>
    </div>

    <!-- Episode Selector Modal -->
    <div class="episode-modal" id="episodeModal">
        <div class="episode-container">
            <div class="episode-header">
                <div class="episode-show-info">
                    <h2 id="episodeShowTitle">Show Title</h2>
                    <p id="episodeShowMeta">Select an episode to watch</p>
                </div>
                <button class="close-episodes" onclick="closeEpisodeSelector()">
                    <svg style="width: 24px; height: 24px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="episode-content">
                <div class="season-sidebar" id="seasonList"></div>
                <div class="episode-list" id="episodeList"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const TMDB_API_KEY = '593f936ea6ac7068502a786d74859854';
        const TMDB_READ_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI1OTNmOTM2ZWE2YWM3MDY4NTAyYTc4NmQ3NDg1OTg1NCIsIm5iZiI6MTczMTMzMTU4Mi44MTMsInN1YiI6IjY3MzIwNWZlNjE2MjZhYzEwNmJlNzJjMiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hgVwkcWxSn9jSmUcTvYMp6a3jPXrkvv5v_W0ONR2nmk';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_BASE = 'https://image.tmdb.org/t/p/original';
        const IMG_POSTER = 'https://image.tmdb.org/t/p/w500';
        const IMG_STILL = 'https://image.tmdb.org/t/p/w300';

        // State
        let currentHeroId = null;
        let currentHeroType = 'movie';
        let currentTVId = null;
        let currentSeason = 1;
        let currentEpisode = 1;
        let currentVideoType = 'movie';
        let currentVideoId = null;
        let watchedEpisodes = JSON.parse(localStorage.getItem('watchedEpisodes') || '{}');
        let continueWatching = JSON.parse(localStorage.getItem('continueWatching') || '[]');
        let myList = JSON.parse(localStorage.getItem('myList') || '[]');
        let watchHistory = JSON.parse(localStorage.getItem('watchHistory') || '[]');
        let searchTimeout = null;
        let currentSearchResults = [];
        let currentSearchQuery = '';
        let currentGenreFilter = 'all';

        // Infinite scroll state
        let moviesPage = 1;
        let tvPage = 1;
        let top50Page = 1;
        let moviesLoading = false;
        let tvLoading = false;
        let top50Loading = false;
        let hasMoreMovies = true;
        let hasMoreTV = true;
        let hasMoreTop50 = true;
        let allMoviesData = [];
        let allTVData = [];
        let allTop50Data = [];
        let currentMoviesSort = 'popular';
        let currentTVSort = 'popular';
        let currentTop50Sort = 'rating';

        // Cache for API data
        const cache = {
            movies: [],
            tv: [],
            hero: null,
            recommended: [],
            newReleases: [],
            topRatedMovies: [],
            topRatedTV: [],
            trending: []
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            setupNavigation();
            setupInfiniteScroll();
            
            // Try to fetch from API
            const success = await fetchAllData();
            
            if (!success) {
                showToast('Using offline mode', 'warning');
            }
            
            // Check URL hash for routing
            const hash = window.location.hash.replace('#', '') || 'home';
            router(hash, false);
            
            // Update continue watching
            updateContinueWatching();
            updateWatchItAgain();
            
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 800);
        }

        function setupNavigation() {
            window.addEventListener('scroll', () => {
                document.getElementById('navContainer').classList.toggle('scrolled', window.scrollY > 50);
            });
            
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.replace('#', '') || 'home';
                showPage(hash);
            });

            // Close search when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('searchSuggestions').classList.remove('active');
                }
                if (!e.target.closest('.sort-dropdown')) {
                    closeAllSortDropdowns();
                }
            });
        }

        function setupInfiniteScroll() {
            // Movies infinite scroll
            const moviesObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !moviesLoading && hasMoreMovies) {
                        loadMoreMovies();
                    }
                });
            }, { rootMargin: '100px' });

            const moviesLoader = document.getElementById('moviesLoader');
            if (moviesLoader) moviesObserver.observe(moviesLoader);

            // TV infinite scroll
            const tvObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !tvLoading && hasMoreTV) {
                        loadMoreTV();
                    }
                });
            }, { rootMargin: '100px' });

            const tvLoader = document.getElementById('tvLoader');
            if (tvLoader) tvObserver.observe(tvLoader);

            // Top 50 infinite scroll
            const top50Observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !top50Loading && hasMoreTop50) {
                        loadMoreTop50();
                    }
                });
            }, { rootMargin: '100px' });

            const top50Loader = document.getElementById('top50Loader');
            if (top50Loader) top50Observer.observe(top50Loader);
        }

        // Filter out items with 0.0 or below rating
        function filterByRating(items) {
            return items.filter(item => {
                const rating = item.vote_average || 0;
                return rating > 0;
            });
        }

        // Toast Notifications
        function showToast(message, type = 'success', title = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '',
                error: '',
                warning: '!'
            };

            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Notice'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // GUI Modal
        function showGuiModal(options) {
            const modal = document.getElementById('guiModal');
            const icon = document.getElementById('guiIcon');
            const title = document.getElementById('guiTitle');
            const message = document.getElementById('guiMessage');
            const buttons = document.getElementById('guiButtons');

            const icons = {
                success: '',
                error: '',
                warning: '!',
                confirm: '?'
            };

            icon.textContent = icons[options.type || 'confirm'];
            icon.className = `gui-icon ${options.type || 'confirm'}`;
            title.textContent = options.title || 'Confirm';
            message.textContent = options.message || '';

            buttons.innerHTML = '';
            
            if (options.buttons) {
                options.buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = `gui-btn ${btn.primary ? 'gui-btn-primary' : 'gui-btn-secondary'}`;
                    button.textContent = btn.text;
                    button.onclick = () => {
                        closeGuiModal();
                        if (btn.onClick) btn.onClick();
                    };
                    buttons.appendChild(button);
                });
            } else {
                buttons.innerHTML = '<button class="gui-btn gui-btn-primary" onclick="closeGuiModal()">OK</button>';
            }

            modal.classList.add('active');
        }

        function closeGuiModal() {
            document.getElementById('guiModal').classList.remove('active');
        }

        // API Functions
        async function fetchTMDB(endpoint, params = '') {
            try {
                const url = `${BASE_URL}${endpoint}?api_key=${TMDB_API_KEY}&language=en-US${params}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${TMDB_READ_TOKEN}`
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('TMDB Error:', error);
                return null;
            }
        }

        async function fetchAllData() {
            try {
                document.getElementById('loadingText').textContent = 'Fetching movies...';
                const movies = await fetchTMDB('/movie/popular', '&page=1');
                if (movies?.results) cache.movies = filterByRating(movies.results);

                document.getElementById('loadingText').textContent = 'Fetching TV shows...';
                const tv = await fetchTMDB('/tv/popular', '&page=1');
                if (tv?.results) cache.tv = filterByRating(tv.results);

                document.getElementById('loadingText').textContent = 'Fetching trending...';
                const trending = await fetchTMDB('/trending/movie/week');
                if (trending?.results) cache.trending = filterByRating(trending.results);

                document.getElementById('loadingText').textContent = 'Fetching new releases...';
                const newReleases = await fetchTMDB('/movie/now_playing');
                if (newReleases?.results) cache.newReleases = filterByRating(newReleases.results);

                document.getElementById('loadingText').textContent = 'Fetching top rated movies...';
                const topRatedMovies = await fetchTMDB('/movie/top_rated');
                if (topRatedMovies?.results) cache.topRatedMovies = filterByRating(topRatedMovies.results);

                document.getElementById('loadingText').textContent = 'Fetching top rated TV...';
                const topRatedTV = await fetchTMDB('/tv/top_rated');
                if (topRatedTV?.results) cache.topRatedTV = filterByRating(topRatedTV.results);

                document.getElementById('loadingText').textContent = 'Fetching recommendations...';
                await fetchRecommendations();

                // Load hero from trending
                if (cache.trending.length > 0) {
                    const heroMovie = cache.trending[Math.floor(Math.random() * Math.min(5, cache.trending.length))];
                    const details = await fetchTMDB(`/movie/${heroMovie.id}`);
                    if (details && details.vote_average > 0) {
                        cache.hero = details;
                        loadHero(details);
                    }
                }

                // Load all sections
                loadHomeSections();

                return true;
            } catch (error) {
                console.error('Failed to fetch data:', error);
                return false;
            }
        }

        async function fetchRecommendations() {
            const randomPage = Math.floor(Math.random() * 5) + 1;
            const recs = await fetchTMDB('/discover/movie', `&sort_by=popularity.desc&page=${randomPage}`);
            if (recs?.results) {
                cache.recommended = shuffleArray(filterByRating(recs.results)).slice(0, 6);
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Load Hero
        function loadHero(movie) {
            currentHeroId = movie.id;
            currentHeroType = 'movie';
            
            document.getElementById('heroTitle').textContent = movie.title;
            document.getElementById('heroRating').textContent = movie.vote_average?.toFixed(1) || '--';
            document.getElementById('heroYear').textContent = movie.release_date?.split('-')[0] || '----';
            document.getElementById('heroDesc').textContent = movie.overview || 'No description available.';
            document.getElementById('heroBg').querySelector('img').src = IMG_BASE + (movie.backdrop_path || movie.poster_path);
            
            if (movie.runtime) {
                const hours = Math.floor(movie.runtime / 60);
                const mins = movie.runtime % 60;
                document.getElementById('heroDuration').textContent = `${hours}h ${mins}m`;
            } else {
                document.getElementById('heroDuration').textContent = '--';
            }

            if (movie.genres?.length > 0) {
                document.getElementById('heroGenre').textContent = movie.genres[0].name;
            } else {
                document.getElementById('heroGenre').textContent = 'Movie';
            }
        }

        // Load Home Sections - Now only shows 4 items per section
        function loadHomeSections() {
            // Top 10 Movies
            const top10Movies = cache.topRatedMovies.slice(0, 10);
            document.getElementById('top10MoviesGrid').innerHTML = top10Movies.map((movie, index) => createTop10Card(movie, index + 1, 'movie')).join('');

            // Top 10 TV Shows
            const top10TV = cache.topRatedTV.slice(0, 10);
            document.getElementById('top10TVGrid').innerHTML = top10TV.map((show, index) => createTop10Card({...show, title: show.name}, index + 1, 'tv')).join('');

            // New Releases - Only 4 items
            document.getElementById('newReleasesGrid').innerHTML = cache.newReleases.slice(0, 4).map(m => createMovieCard(m, 'movie')).join('');

            // Trending Now - Only 4 items
            document.getElementById('trendingGrid').innerHTML = cache.trending.slice(0, 4).map(m => createMovieCard(m, 'movie')).join('');

            // Popular Series - Only 4 items
            document.getElementById('popularGrid').innerHTML = cache.tv.slice(0, 4).map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');

            // Recommended - Only 4 items
            document.getElementById('recommendedGrid').innerHTML = cache.recommended.slice(0, 4).map(m => createMovieCard(m, 'movie')).join('');
        }

        // Create Top 10 Card
        function createTop10Card(item, rank, type) {
            return `
                <div class="top-10-card" onclick="handleContentClick(${item.id}, '${type}')">
                    <div class="top-10-number">${rank}</div>
                    <div class="top-10-image">
                        <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1c1c1e/98989d?text=${encodeURIComponent(item.title)}'">
                    </div>
                </div>
            `;
        }

        // Watch It Again
        function updateWatchItAgain() {
            const section = document.getElementById('watchItAgainSection');
            const grid = document.getElementById('watchItAgainGrid');
            
            if (watchHistory.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            // Get unique items from history, most recent first
            const uniqueHistory = [...new Map(watchHistory.slice().reverse().map(item => [item.id, item])).values()].slice(0, 6);
            
            grid.innerHTML = uniqueHistory.map(item => {
                const displayItem = {
                    id: item.id,
                    title: item.title,
                    poster_path: item.poster_path,
                    vote_average: parseFloat(item.rating) || 0,
                    release_date: item.year + '-01-01'
                };
                return createMovieCard(displayItem, item.type);
            }).join('');
        }

        function clearWatchHistory() {
            showGuiModal({
                type: 'confirm',
                title: 'Clear History?',
                message: 'This will remove all items from your watch history.',
                buttons: [
                    { text: 'Clear', primary: true, onClick: () => {
                        watchHistory = [];
                        localStorage.setItem('watchHistory', JSON.stringify(watchHistory));
                        updateWatchItAgain();
                        showToast('History cleared', 'success');
                    }},
                    { text: 'Cancel', primary: false, onClick: () => {} }
                ]
            });
        }

        async function refreshRecommendations() {
            const icon = document.getElementById('refreshIcon');
            icon.style.transform = 'rotate(360deg)';
            
            await fetchRecommendations();
            document.getElementById('recommendedGrid').innerHTML = cache.recommended.slice(0, 4).map(m => createMovieCard(m, 'movie')).join('');
            
            setTimeout(() => {
                icon.style.transform = 'rotate(0deg)';
            }, 300);
            
            showToast('Recommendations updated', 'success');
        }

        // Create Movie Card - FIXED WISHLIST FUNCTIONALITY
        function createMovieCard(item, type) {
            const year = type === 'movie' ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0];
            const totalEpisodes = type === 'tv' ? item.number_of_episodes : 1;
            const isCompleted = type === 'tv' ? isSeriesCompleted(item.id, totalEpisodes) : false;
            const progress = getProgress(item.id, type);
            const inList = myList.some(i => i.id === item.id && i.type === type);
            
            return `
                <div class="movie-card ${isCompleted ? 'completed' : ''}" data-id="${item.id}" data-type="${type}">
                    <button class="add-to-list-btn ${inList ? 'in-list' : ''}" onclick="toggleListFromCard(${item.id}, '${type}', event)" title="${inList ? 'In List' : 'Add to List'}">
                        ${inList ? '' : '+'}
                    </button>
                    ${isCompleted ? `
                        <div class="completed-badge">
                            <svg style="width: 16px; height: 16px; fill: white;" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </div>
                    ` : ''}
                    <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1c1c1e/98989d?text=${encodeURIComponent(item.title)}'">
                    ${progress > 0 && progress < 100 ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    ` : ''}
                    <div class="play-icon">
                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <div class="movie-overlay" onclick="handleContentClick(${item.id}, '${type}')">
                        <div class="movie-title">${item.title}</div>
                        <div class="movie-meta">
                            <span class="movie-rating">
                                <svg style="width: 14px; height: 14px; fill: currentColor;" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                ${item.vote_average?.toFixed(1) || '--'}
                            </span>
                            <span>${year || '----'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // FIXED: Toggle list from card - Now works with all content sources
        function toggleListFromCard(id, type, event) {
            if (event) event.stopPropagation();
            
            // Try to find item in all possible data sources
            let item = null;
            
            if (type === 'movie') {
                item = cache.movies.find(m => m.id === id) || 
                       allMoviesData.find(m => m.id === id) || 
                       allTop50Data.find(m => m.id === id) ||
                       cache.newReleases.find(m => m.id === id) ||
                       cache.trending.find(m => m.id === id) ||
                       cache.recommended.find(m => m.id === id) ||
                       cache.topRatedMovies.find(m => m.id === id);
            } else {
                item = cache.tv.find(t => t.id === id) || 
                       allTVData.find(t => t.id === id) ||
                       cache.topRatedTV.find(t => t.id === id);
            }
            
            if (!item) {
                // If not in cache, try to fetch details
                showToast('Adding to list...', 'success');
                fetchItemDetails(id, type).then(details => {
                    if (details) {
                        addToListInternal(details, type);
                    } else {
                        showToast('Could not add to list', 'error');
                    }
                });
                return;
            }
            
            addToListInternal(item, type);
        }

        async function fetchItemDetails(id, type) {
            const endpoint = type === 'movie' ? `/movie/${id}` : `/tv/${id}`;
            return await fetchTMDB(endpoint);
        }

        function addToListInternal(item, type) {
            const listItem = {
                id: item.id,
                title: item.title || item.name,
                poster_path: item.poster_path,
                rating: item.vote_average?.toFixed(1),
                year: type === 'movie' ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0],
                type: type
            };
            
            const existingIndex = myList.findIndex(i => i.id === item.id && i.type === type);
            
            if (existingIndex > -1) {
                myList.splice(existingIndex, 1);
                showToast('Removed from My List', 'success');
            } else {
                myList.push(listItem);
                showToast('Added to My List', 'success');
            }
            
            localStorage.setItem('myList', JSON.stringify(myList));
            
            // Update all visible cards with this item
            updateListButtons(item.id, type, existingIndex === -1);
            
            // If on mylist page, refresh it
            if (document.getElementById('page-mylist').classList.contains('active')) {
                loadMyList();
            }
        }

        function updateListButtons(id, type, inList) {
            const buttons = document.querySelectorAll(`.movie-card[data-id="${id}"][data-type="${type}"] .add-to-list-btn`);
            buttons.forEach(btn => {
                btn.classList.toggle('in-list', inList);
                btn.textContent = inList ? '' : '+';
                btn.title = inList ? 'In List' : 'Add to List';
            });
        }

        // Progress Tracking
        function getProgress(id, type) {
            if (type === 'movie') {
                const watched = watchedEpisodes[`movie-${id}`];
                return watched ? 100 : 0;
            } else {
                const show = cache.tv.find(t => t.id === id) || allTVData.find(t => t.id === id);
                if (!show) return 0;
                const watched = watchedEpisodes[id] || {};
                const watchedCount = Object.keys(watched).length;
                return (watchedCount / (show.number_of_episodes || 1)) * 100;
            }
        }

        function isSeriesCompleted(id, totalEpisodes) {
            const watched = watchedEpisodes[id] || {};
            return Object.keys(watched).length >= totalEpisodes;
        }

        // Continue Watching
        function updateContinueWatching() {
            const container = document.getElementById('continueWatchingContainer');
            if (!continueWatching.length) {
                container.style.display = 'none';
                return;
            }

            const latest = continueWatching[continueWatching.length - 1];
            const item = latest.type === 'movie' 
                ? cache.movies.find(m => m.id === latest.id) || allMoviesData.find(m => m.id === latest.id)
                : cache.tv.find(t => t.id === latest.id) || allTVData.find(t => t.id === latest.id);

            if (!item) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = `
                <div class="continue-banner" onclick="resumeWatching(${latest.id}, '${latest.type}')">
                    <div class="continue-info">
                        <div class="continue-thumb">
                            <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title || item.name}">
                        </div>
                        <div class="continue-text">
                            <h3>Continue Watching</h3>
                            <p>${item.title || item.name} ${latest.episode ? `- S${latest.season}E${latest.episode}` : ''}</p>
                        </div>
                    </div>
                    <button class="continue-btn">
                        <svg style="width: 24px; height: 24px; fill: white;" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                </div>
            `;
        }

        function resumeWatching(id, type) {
            const item = continueWatching.find(c => c.id === id && c.type === type);
            if (!item) return;

            if (type === 'tv' && item.season && item.episode) {
                const url = `https://vidfast.pro/tv/${id}/${item.season}/${item.episode}?autoPlay=true`;
                playContent(url, 'tv', id, item.season, item.episode);
            } else {
                handleContentClick(id, type);
            }
        }

        // Search Functionality
        function handleSearchInput(query) {
            if (!query.trim()) {
                document.getElementById('searchSuggestions').classList.remove('active');
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const results = await fetchTMDB('/search/multi', `&query=${encodeURIComponent(query)}&page=1`);
                
                if (results?.results) {
                    const filteredResults = filterByRating(results.results);
                    showSearchSuggestions(filteredResults.slice(0, 5));
                }
            }, 300);
        }

        function handleSearchKey(e) {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if (query) {
                    document.getElementById('searchSuggestions').classList.remove('active');
                    performSearch(query);
                }
            }
        }

        function showSearchHistory() {
            if (searchHistory.length === 0) return;
            
            const container = document.getElementById('searchSuggestions');
            container.innerHTML = `
                <div class="suggestion-header">Recent Searches</div>
                ${searchHistory.slice(0, 5).map(item => `
                    <div class="suggestion-item" onclick="performSearch('${item}')">
                        <div class="suggestion-info">
                            <div class="suggestion-title">${item}</div>
                        </div>
                        <span class="suggestion-type" style="background: var(--bg-tertiary);">History</span>
                    </div>
                `).join('')}`;
            container.classList.add('active');
        }

        function showSearchSuggestions(results) {
            const container = document.getElementById('searchSuggestions');
            
            container.innerHTML = `
                <div class="suggestion-header">Suggestions</div>
                ${results.map(item => {
                    const isMovie = item.media_type === 'movie';
                    const title = isMovie ? item.title : item.name;
                    const year = isMovie ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0];
                    
                    return `
                        <div class="suggestion-item" onclick="selectSearchResult(${item.id}, '${item.media_type}')">
                            <div class="suggestion-thumb">
                                <img src="${item.poster_path ? IMG_POSTER + item.poster_path : 'https://via.placeholder.com/50x75/1c1c1e/98989d?text=?'}" alt="${title}">
                            </div>
                            <div class="suggestion-info">
                                <div class="suggestion-title">${title}</div>
                                <div class="suggestion-meta">
                                    <span class="suggestion-rating">
                                        <svg style="width: 12px; height: 12px; fill: currentColor;" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                        ${item.vote_average?.toFixed(1) || '--'}
                                    </span>
                                    <span>${year || '----'}</span>
                                </div>
                            </div>
                            <span class="suggestion-type">${isMovie ? 'Movie' : 'TV'}</span>
                        </div>
                    `;
                }).join('')}`;

            container.classList.add('active');
        }

        async function performSearch(query) {
            currentSearchQuery = query;
            document.getElementById('searchQueryDisplay').textContent = query;
            
            if (!searchHistory.includes(query)) {
                searchHistory.unshift(query);
                if (searchHistory.length > 10) searchHistory.pop();
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            }
            
            const results = await fetchTMDB('/search/multi', `&query=${encodeURIComponent(query)}&page=1`);
            
            if (results?.results) {
                currentSearchResults = filterByRating(results.results.filter(r => r.media_type === 'movie' || r.media_type === 'tv'));
                document.getElementById('searchResultsCount').textContent = currentSearchResults.length;
                displaySearchResults(currentSearchResults);
            }
            
            router('search');
        }

        function displaySearchResults(results) {
            const grid = document.getElementById('searchResultsGrid');
            const noResults = document.getElementById('noSearchResults');
            
            if (results.length === 0) {
                grid.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            grid.innerHTML = results.map(item => {
                const type = item.media_type;
                const displayItem = {...item, title: item.title || item.name};
                return createMovieCard(displayItem, type);
            }).join('');
        }

        function filterSearchResults(query) {
            if (!query) {
                displaySearchResults(currentSearchResults);
                return;
            }
            
            const filtered = currentSearchResults.filter(item => {
                const title = (item.title || item.name).toLowerCase();
                return title.includes(query.toLowerCase());
            });
            
            displaySearchResults(filtered);
        }

        function selectSearchResult(id, type) {
            document.getElementById('searchSuggestions').classList.remove('active');
            handleContentClick(id, type === 'movie' ? 'movie' : 'tv');
        }

        // Sort and Filter
        function toggleSortDropdown() {
            document.getElementById('sortDropdown').classList.toggle('active');
        }

        function toggleMoviesSort() {
            document.getElementById('moviesSortDropdown').classList.toggle('active');
        }

        function toggleTVSort() {
            document.getElementById('tvSortDropdown').classList.toggle('active');
        }

        function toggleTop50Sort() {
            document.getElementById('top50SortDropdown').classList.toggle('active');
        }

        function closeAllSortDropdowns() {
            document.querySelectorAll('.sort-dropdown').forEach(d => d.classList.remove('active'));
        }

        function sortResults(criteria, label) {
            document.getElementById('currentSort').textContent = `Sort by: ${label}`;
            document.querySelectorAll('#sortDropdown .sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            let sorted = [...currentSearchResults];
            
            switch(criteria) {
                case 'rating':
                    sorted.sort((a, b) => b.vote_average - a.vote_average);
                    break;
                case 'date_new':
                    sorted.sort((a, b) => new Date(b.release_date || b.first_air_date) - new Date(a.release_date || a.first_air_date));
                    break;
                case 'date_old':
                    sorted.sort((a, b) => new Date(a.release_date || a.first_air_date) - new Date(b.release_date || b.first_air_date));
                    break;
                case 'title_az':
                    sorted.sort((a, b) => (a.title || a.name).localeCompare(b.title || b.name));
                    break;
                case 'title_za':
                    sorted.sort((a, b) => (b.title || b.name).localeCompare(a.title || a.name));
                    break;
                default:
                    break;
            }
            
            displaySearchResults(sorted);
        }

        function filterByGenre(genreId) {
            currentGenreFilter = genreId;
            
            document.querySelectorAll('#searchGenreFilter .genre-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (genreId === 'all') {
                displaySearchResults(currentSearchResults);
                return;
            }
            
            const filtered = currentSearchResults.filter(item => {
                return item.genre_ids && item.genre_ids.includes(parseInt(genreId));
            });
            
            displaySearchResults(filtered);
        }

        // Infinite Scroll for Movies
        async function loadMoreMovies() {
            if (moviesLoading || !hasMoreMovies) return;
            
            moviesLoading = true;
            moviesPage++;
            document.getElementById('moviesLoader').classList.remove('hidden');
            
            let sortParam = '';
            switch(currentMoviesSort) {
                case 'rating': sortParam = '&sort_by=vote_average.desc'; break;
                case 'latest': sortParam = '&sort_by=release_date.desc'; break;
                case 'title_az': sortParam = '&sort_by=original_title.asc'; break;
                default: sortParam = '&sort_by=popularity.desc';
            }
            
            const results = await fetchTMDB('/discover/movie', `&page=${moviesPage}${sortParam}`);
            
            if (results?.results) {
                const filtered = filterByRating(results.results);
                if (filtered.length === 0) {
                    hasMoreMovies = false;
                } else {
                    allMoviesData = [...allMoviesData, ...filtered];
                    appendMoviesToGrid(filtered);
                }
            } else {
                hasMoreMovies = false;
            }
            
            moviesLoading = false;
            document.getElementById('moviesLoader').classList.add('hidden');
        }

        function appendMoviesToGrid(movies) {
            const grid = document.getElementById('allMoviesGrid');
            const html = movies.map(m => createMovieCard(m, 'movie')).join('');
            grid.insertAdjacentHTML('beforeend', html);
        }

        // Infinite Scroll for TV
        async function loadMoreTV() {
            if (tvLoading || !hasMoreTV) return;
            
            tvLoading = true;
            tvPage++;
            document.getElementById('tvLoader').classList.remove('hidden');
            
            let sortParam = '';
            switch(currentTVSort) {
                case 'rating': sortParam = '&sort_by=vote_average.desc'; break;
                case 'latest': sortParam = '&sort_by=first_air_date.desc'; break;
                case 'title_az': sortParam = '&sort_by=original_name.asc'; break;
                default: sortParam = '&sort_by=popularity.desc';
            }
            
            const results = await fetchTMDB('/discover/tv', `&page=${tvPage}${sortParam}`);
            
            if (results?.results) {
                const filtered = filterByRating(results.results);
                if (filtered.length === 0) {
                    hasMoreTV = false;
                } else {
                    allTVData = [...allTVData, ...filtered];
                    appendTVToGrid(filtered);
                }
            } else {
                hasMoreTV = false;
            }
            
            tvLoading = false;
            document.getElementById('tvLoader').classList.add('hidden');
        }

        function appendTVToGrid(shows) {
            const grid = document.getElementById('allTVGrid');
            const html = shows.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
            grid.insertAdjacentHTML('beforeend', html);
        }

        // TOP 50 INFINITE SCROLL
        async function loadMoreTop50() {
            if (top50Loading || !hasMoreTop50) return;
            
            top50Loading = true;
            top50Page++;
            document.getElementById('top50Loader').classList.remove('hidden');
            
            // Fetch top rated movies (this is the IMDb Top 50 equivalent)
            const results = await fetchTMDB('/movie/top_rated', `&page=${top50Page}`);
            
            if (results?.results) {
                const filtered = filterByRating(results.results);
                if (filtered.length === 0 || allTop50Data.length >= 50) {
                    hasMoreTop50 = false;
                } else {
                    // Limit to 50 total
                    const remainingSlots = 50 - allTop50Data.length;
                    const toAdd = filtered.slice(0, remainingSlots);
                    allTop50Data = [...allTop50Data, ...toAdd];
                    appendTop50ToGrid(toAdd);
                    
                    if (allTop50Data.length >= 50) hasMoreTop50 = false;
                }
            } else {
                hasMoreTop50 = false;
            }
            
            top50Loading = false;
            if (hasMoreTop50) {
                document.getElementById('top50Loader').classList.add('hidden');
            } else {
                document.getElementById('top50Loader').style.display = 'none';
            }
        }

        function appendTop50ToGrid(movies) {
            const grid = document.getElementById('top50Grid');
            const html = movies.map(m => createMovieCard(m, 'movie')).join('');
            grid.insertAdjacentHTML('beforeend', html);
        }

        function filterTop50(query) {
            const grid = document.getElementById('top50Grid');
            if (!query) {
                grid.innerHTML = allTop50Data.map(m => createMovieCard(m, 'movie')).join('');
                return;
            }
            
            const filtered = allTop50Data.filter(m => m.title.toLowerCase().includes(query.toLowerCase()));
            grid.innerHTML = filtered.map(m => createMovieCard(m, 'movie')).join('');
        }

        function sortTop50(criteria) {
            currentTop50Sort = criteria;
            const labels = {
                rating: 'IMDb Rating',
                popular: 'Popularity',
                latest: 'Latest',
                title_az: 'A-Z'
            };
            document.getElementById('top50CurrentSort').textContent = `Sort by: ${labels[criteria]}`;
            
            event.target.parentElement.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            let sorted = [...allTop50Data];
            switch(criteria) {
                case 'rating':
                    sorted.sort((a, b) => b.vote_average - a.vote_average);
                    break;
                case 'popular':
                    sorted.sort((a, b) => b.popularity - a.popularity);
                    break;
                case 'latest':
                    sorted.sort((a, b) => new Date(b.release_date) - new Date(a.release_date));
                    break;
                case 'title_az':
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                    break;
            }
            
            document.getElementById('top50Grid').innerHTML = sorted.map(m => createMovieCard(m, 'movie')).join('');
        }

        // Movies and TV filtering
        function filterMovies(query) {
            const grid = document.getElementById('allMoviesGrid');
            if (!query) {
                grid.innerHTML = allMoviesData.map(m => createMovieCard(m, 'movie')).join('');
                return;
            }
            
            const filtered = allMoviesData.filter(m => m.title.toLowerCase().includes(query.toLowerCase()));
            grid.innerHTML = filtered.map(m => createMovieCard(m, 'movie')).join('');
        }

        function filterTV(query) {
            const grid = document.getElementById('allTVGrid');
            if (!query) {
                grid.innerHTML = allTVData.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
                return;
            }
            
            const filtered = allTVData.filter(t => t.name.toLowerCase().includes(query.toLowerCase()));
            grid.innerHTML = filtered.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
        }

        async function sortMovies(criteria) {
            currentMoviesSort = criteria;
            const labels = {
                popular: 'Popularity',
                rating: 'Highest Rated',
                latest: 'Latest',
                title_az: 'A-Z'
            };
            document.getElementById('moviesCurrentSort').textContent = `Sort by: ${labels[criteria]}`;
            
            event.target.parentElement.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            moviesPage = 1;
            hasMoreMovies = true;
            allMoviesData = [];
            document.getElementById('allMoviesGrid').innerHTML = '';
            
            await loadMoreMovies();
        }

        async function sortTV(criteria) {
            currentTVSort = criteria;
            const labels = {
                popular: 'Popularity',
                rating: 'Highest Rated',
                latest: 'Latest',
                title_az: 'A-Z'
            };
            document.getElementById('tvCurrentSort').textContent = `Sort by: ${labels[criteria]}`;
            
            event.target.parentElement.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            tvPage = 1;
            hasMoreTV = true;
            allTVData = [];
            document.getElementById('allTVGrid').innerHTML = '';
            
            await loadMoreTV();
        }

        // Content Click Handler
        async function handleContentClick(id, type) {
            currentVideoType = type;
            currentVideoId = id;

            // Add to watch history
            const item = type === 'movie'
                ? (cache.movies.find(m => m.id === id) || allMoviesData.find(m => m.id === id) || allTop50Data.find(m => m.id === id))
                : (cache.tv.find(t => t.id === id) || allTVData.find(t => t.id === id));
            
            if (item) {
                const historyItem = {
                    id: item.id,
                    title: item.title || item.name,
                    poster_path: item.poster_path,
                    rating: item.vote_average?.toFixed(1),
                    year: type === 'movie' ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0],
                    type: type,
                    timestamp: Date.now()
                };
                watchHistory.push(historyItem);
                if (watchHistory.length > 50) watchHistory = watchHistory.slice(-50);
                localStorage.setItem('watchHistory', JSON.stringify(watchHistory));
                updateWatchItAgain();
            }

            if (type === 'tv') {
                currentTVId = id;
                let show = cache.tv.find(t => t.id === id) || allTVData.find(t => t.id === id);
                if (!show) {
                    show = await fetchTMDB(`/tv/${id}`);
                    if (show && show.vote_average > 0) {
                        cache.tv.push(show);
                    }
                }
                
                if (show && show.vote_average > 0) {
                    const progress = getWatchingProgress(id);
                    if (progress) {
                        showGuiModal({
                            type: 'confirm',
                            title: 'Resume Watching?',
                            message: `Continue from S${progress.season}E${progress.episode} - ${progress.episodeName}?`,
                            buttons: [
                                { text: 'Resume', primary: true, onClick: () => {
                                    playEpisode(progress.season, progress.episode, progress.episodeName, false);
                                }},
                                { text: 'Start Over', primary: false, onClick: () => {
                                    openEpisodeSelector(show);
                                }}
                            ]
                        });
                        return;
                    }
                    openEpisodeSelector(show);
                }
            } else {
                playContent(`https://vidfast.pro/movie/${id}`, 'movie', id);
            }
        }

        function getWatchingProgress(id) {
            const entry = continueWatching.find(c => c.id === id && c.type === 'tv');
            return entry || null;
        }

        // Episode Selector
        async function openEpisodeSelector(show) {
            currentTVId = show.id;
            document.getElementById('episodeShowTitle').textContent = show.name;
            document.getElementById('episodeShowMeta').textContent = `${show.number_of_seasons} Seasons  ${show.number_of_episodes} Episodes`;

            const seasonsData = await fetchTMDB(`/tv/${show.id}`);
            const seasons = seasonsData?.seasons?.filter(s => s.season_number > 0) || [];

            document.getElementById('seasonList').innerHTML = `
                <div class="season-title">Seasons</div>
                ${seasons.map(s => `
                    <button class="season-btn ${s.season_number === currentSeason ? 'active' : ''}" onclick="switchSeason(${s.season_number})">
                        <span>Season ${s.season_number}</span>
                        <span style="color: var(--text-secondary); font-size: 14px;">${s.episode_count} ep</span>
                    </button>
                `).join('')}`;

            document.getElementById('episodeModal').classList.add('active');
            await loadEpisodes(currentSeason, show.id);
        }

        async function switchSeason(seasonNum) {
            currentSeason = seasonNum;
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(`Season ${seasonNum}`));
            });
            await loadEpisodes(seasonNum, currentTVId);
        }

        async function loadEpisodes(seasonNum, showId) {
            const data = await fetchTMDB(`/tv/${showId}/season/${seasonNum}`);
            if (!data?.episodes) return;

            const showWatched = watchedEpisodes[showId] || {};
            const continueItem = continueWatching.find(c => c.id === showId && c.type === 'tv');

            document.getElementById('episodeList').innerHTML = data.episodes.map(ep => {
                const epKey = `${seasonNum}-${ep.episode_number}`;
                const isWatched = showWatched[epKey];
                const isCurrent = continueItem && continueItem.season === seasonNum && continueItem.episode === ep.episode_number;

                return `
                    <div class="episode-item ${isWatched ? 'watched' : ''} ${isCurrent ? 'current' : ''}" onclick="playEpisode(${seasonNum}, ${ep.episode_number}, '${ep.name.replace(/'/g, "\\'")}', true)">
                        <div class="episode-thumb">
                            <img src="${ep.still_path ? IMG_STILL + ep.still_path : 'https://via.placeholder.com/160x90/1c1c1e/98989d?text=Ep+' + ep.episode_number}" alt="${ep.name}">
                            <span class="episode-duration">${ep.runtime || 45}m</span>
                        </div>
                        <div class="episode-info">
                            <div class="episode-number">Episode ${ep.episode_number}</div>
                            <div class="episode-name">${ep.name}</div>
                            <div class="episode-desc">${ep.overview || 'No description available.'}</div>
                            ${isWatched ? `
                                <div class="episode-status">
                                    <svg class="watched-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    Watched
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function playEpisode(season, episode, episodeName, saveProgress = true) {
            currentSeason = season;
            currentEpisode = episode;

            if (saveProgress) {
                if (!watchedEpisodes[currentTVId]) watchedEpisodes[currentTVId] = {};
                watchedEpisodes[currentTVId][`${season}-${episode}`] = true;
                localStorage.setItem('watchedEpisodes', JSON.stringify(watchedEpisodes));

                const existingIndex = continueWatching.findIndex(c => c.id === currentTVId && c.type === 'tv');
                const newEntry = {
                    id: currentTVId,
                    type: 'tv',
                    season: season,
                    episode: episode,
                    episodeName: episodeName,
                    timestamp: Date.now()
                };

                if (existingIndex > -1) {
                    continueWatching[existingIndex] = newEntry;
                } else {
                    continueWatching.push(newEntry);
                }
                
                if (continueWatching.length > 10) {
                    continueWatching = continueWatching.slice(-10);
                }
                
                localStorage.setItem('continueWatching', JSON.stringify(continueWatching));
                updateContinueWatching();

                const show = cache.tv.find(t => t.id === currentTVId) || allTVData.find(t => t.id === currentTVId);
                if (show && isSeriesCompleted(currentTVId, show.number_of_episodes)) {
                    showToast(`You've completed ${show.name}!`, 'success');
                }
            }

            await loadEpisodes(season, currentTVId);

            const url = `https://vidfast.pro/tv/${currentTVId}/${season}/${episode}?autoPlay=true`;
            closeEpisodeSelector();
            playContent(url, 'tv', currentTVId, season, episode);
        }

        function closeEpisodeSelector() {
            document.getElementById('episodeModal').classList.remove('active');
        }

        // Video Player
        function playContent(url, type, id, season = null, episode = null) {
            currentVideoType = type;
            currentVideoId = id;

            document.getElementById('videoWrapper').innerHTML = `
                <iframe src="${url}" frameborder="0" allowfullscreen allow="encrypted-media; autoplay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
            `;

            document.getElementById('episodesBtn').style.display = type === 'tv' ? 'flex' : 'none';
            document.getElementById('videoModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function playHero() {
            if (!currentHeroId) return;
            handleContentClick(currentHeroId, currentHeroType);
        }

        function closeVideo() {
            document.getElementById('videoWrapper').innerHTML = '';
            document.getElementById('videoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleEpisodeSelector() {
            if (currentVideoType === 'tv' && currentTVId) {
                const show = cache.tv.find(t => t.id === currentTVId) || allTVData.find(t => t.id === currentTVId);
                if (show) openEpisodeSelector(show);
            }
        }

        // My List Functions
        function addHeroToList() {
            if (!cache.hero) return;
            
            const item = {
                id: cache.hero.id,
                title: cache.hero.title,
                poster_path: cache.hero.poster_path,
                rating: cache.hero.vote_average?.toFixed(1),
                year: cache.hero.release_date?.split('-')[0],
                type: 'movie'
            };
            
            addToMyList(item);
        }

        function addToMyList(item) {
            if (myList.some(i => i.id === item.id && i.type === item.type)) {
                showToast('Already in your list', 'warning');
                return;
            }

            myList.push(item);
            localStorage.setItem('myList', JSON.stringify(myList));
            showToast('Added to My List', 'success');
            
            // Update button if visible
            updateListButtons(item.id, item.type, true);
        }

        function removeFromList(id, event) {
            if (event) event.stopPropagation();
            myList = myList.filter(item => item.id !== id);
            localStorage.setItem('myList', JSON.stringify(myList));
            loadMyList();
            showToast('Removed from My List', 'success');
            
            // Update buttons on other pages
            const item = myList.find(i => i.id === id);
            if (item) updateListButtons(id, item.type, false);
        }

        function clearMyList() {
            if (!myList.length) return;
            
            showGuiModal({
                type: 'confirm',
                title: 'Clear List?',
                message: 'Are you sure you want to remove all items from your list?',
                buttons: [
                    { text: 'Clear', primary: true, onClick: () => {
                        myList = [];
                        localStorage.setItem('myList', JSON.stringify(myList));
                        loadMyList();
                        showToast('List cleared', 'success');
                    }},
                    { text: 'Cancel', primary: false, onClick: () => {} }
                ]
            });
        }

        function loadMyList() {
            const grid = document.getElementById('myListGrid');
            const emptyState = document.getElementById('emptyState');
            const clearBtn = document.getElementById('clearListBtn');

            if (!myList.length) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                clearBtn.style.display = 'none';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            clearBtn.style.display = 'flex';

            grid.innerHTML = myList.map(item => `
                <div class="movie-card" data-id="${item.id}" data-type="${item.type}">
                    <button class="remove-btn" onclick="removeFromList(${item.id}, event)" title="Remove">
                        <svg style="width: 16px; height: 16px; fill: white;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                    <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1c1c1e/98989d?text=${encodeURIComponent(item.title)}'">
                    <div class="play-icon" onclick="playItem(${item.id}, '${item.type}')">
                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <div class="movie-overlay">
                        <div class="movie-title">${item.title}</div>
                        <div class="movie-meta">
                            <span class="movie-rating">
                                <svg style="width: 14px; height: 14px; fill: currentColor;" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                ${item.rating}
                            </span>
                            <span>${item.year}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function playItem(id, type) {
            handleContentClick(id, type);
        }

        // Router
        function router(route, updateHash = true) {
            if (updateHash) {
                window.location.hash = route;
            }
            showPage(route);
        }

        async function showPage(route) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            const pageId = `page-${route}`;
            const page = document.getElementById(pageId);
            
            if (page) {
                page.classList.add('active');
            } else {
                document.getElementById('page-home').classList.add('active');
                route = 'home';
            }

            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const navLink = document.getElementById(`nav-${route}`);
            if (navLink) navLink.classList.add('active');

            const logo = document.getElementById('navLogo');
            if (route === 'home') {
                logo.classList.remove('hidden');
            } else {
                logo.classList.add('hidden');
            }

            window.scrollTo(0, 0);

            if (route === 'mylist') loadMyList();
            if (route === 'movies' && allMoviesData.length === 0) {
                document.getElementById('moviesLoader').classList.remove('hidden');
                await loadMoreMovies();
            }
            if (route === 'tv' && allTVData.length === 0) {
                document.getElementById('tvLoader').classList.remove('hidden');
                await loadMoreTV();
            }
            if (route === 'top50' && allTop50Data.length === 0) {
                document.getElementById('top50Loader').classList.remove('hidden');
                // Load first page of top 50
                const results = await fetchTMDB('/movie/top_rated', '&page=1');
                if (results?.results) {
                    const filtered = filterByRating(results.results).slice(0, 20); // Load first 20 initially
                    allTop50Data = filtered;
                    document.getElementById('top50Grid').innerHTML = filtered.map(m => createMovieCard(m, 'movie')).join('');
                }
            }
        }

        // Close modals on background click
        document.getElementById('videoModal').addEventListener('click', (e) => {
            if (e.target.id === 'videoModal') closeVideo();
        });

        document.getElementById('episodeModal').addEventListener('click', (e) => {
            if (e.target.id === 'episodeModal') closeEpisodeSelector();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('guiModal').classList.contains('active')) {
                    closeGuiModal();
                } else if (document.getElementById('episodeModal').classList.contains('active')) {
                    closeEpisodeSelector();
                } else {
                    closeVideo();
                }
            }
        });
    </script>

</body>
</html>
