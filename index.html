<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineStream - Premium Entertainment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --accent: #0a84ff;
            --accent-secondary: #5e5ce6;
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --text-tertiary: #636366;
            --glass: rgba(28, 28, 30, 0.72);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #30d158;
            --warning: #ff9f0a;
            --error: #ff3b30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.47059;
            font-weight: 400;
            letter-spacing: -0.022em;
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 16px 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            min-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast.success .toast-icon { background: var(--success); }
        .toast.error .toast-icon { background: var(--error); }
        .toast.warning .toast-icon { background: var(--warning); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* GUI Modal */
        .gui-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 6000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gui-modal.active {
            display: flex;
            opacity: 1;
        }

        .gui-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--glass-border);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .gui-modal.active .gui-content {
            transform: scale(1);
        }

        .gui-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gui-icon.success { background: rgba(48, 209, 88, 0.2); color: var(--success); }
        .gui-icon.error { background: rgba(255, 59, 48, 0.2); color: var(--error); }
        .gui-icon.warning { background: rgba(255, 159, 10, 0.2); color: var(--warning); }
        .gui-icon.confirm { background: rgba(10, 132, 255, 0.2); color: var(--accent); }

        .gui-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .gui-message {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .gui-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .gui-btn {
            padding: 12px 24px;
            border-radius: 100px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gui-btn-primary {
            background: var(--accent);
            color: white;
        }

        .gui-btn-primary:hover {
            background: #0070e0;
        }

        .gui-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .gui-btn-secondary:hover {
            background: var(--glass-border);
        }

        /* Navigation */
        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 16px 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-container.scrolled {
            background: var(--glass);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.021em;
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .logo.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .nav-links {
            display: flex;
            gap: 32px;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text-primary);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            width: 100%;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Search Bar */
        .search-container {
            position: relative;
        }

        .search-bar {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: 100px;
            padding: 8px 16px;
            width: 40px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .search-bar.active {
            width: 300px;
            border-color: var(--glass-border);
        }

        .search-bar input {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            width: 100%;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .search-bar.active input {
            opacity: 1;
        }

        .search-btn {
            width: 24px;
            height: 24px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 400px;
            max-height: 500px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid var(--glass-border);
        }

        .suggestion-item:hover {
            background: var(--bg-tertiary);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-thumb {
            width: 50px;
            height: 75px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-tertiary);
        }

        .suggestion-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .suggestion-info {
            flex: 1;
        }

        .suggestion-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .suggestion-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .suggestion-type {
            padding: 4px 8px;
            background: var(--accent);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hero Section */
        .hero {
            position: relative;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            padding: 0 0 140px;
        }

        .hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        .hero-bg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
        }

        .hero-gradient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                rgba(0,0,0,0.2) 0%, 
                rgba(0,0,0,0.5) 50%,
                var(--bg-primary) 100%);
            z-index: -1;
        }

        .hero-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 48px;
            width: 100%;
            z-index: 2;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .hero-title {
            font-size: 72px;
            font-weight: 800;
            line-height: 1.05;
            letter-spacing: -0.015em;
            margin-bottom: 20px;
            max-width: 800px;
        }

        .hero-meta {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            font-size: 17px;
            color: var(--text-secondary);
        }

        .hero-meta .rating {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ffd60a;
            font-weight: 600;
        }

        .hero-meta .year {
            font-weight: 600;
            color: var(--text-primary);
        }

        .hero-description {
            font-size: 21px;
            line-height: 1.4;
            color: var(--text-secondary);
            max-width: 650px;
            margin-bottom: 32px;
        }

        .hero-actions {
            display: flex;
            gap: 16px;
        }

        .btn {
            padding: 16px 32px;
            border-radius: 100px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(255,255,255,0.2);
        }

        .btn-secondary {
            background: var(--glass);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.02);
        }

        .btn-danger {
            background: rgba(255, 59, 48, 0.2);
            color: var(--error);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .btn-danger:hover {
            background: rgba(255, 59, 48, 0.3);
        }

        /* Continue Watching Banner */
        .continue-banner {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), rgba(94, 92, 230, 0.1));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .continue-banner:hover {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.2), rgba(94, 92, 230, 0.2));
            transform: translateX(8px);
        }

        .continue-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .continue-thumb {
            width: 80px;
            height: 45px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .continue-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .continue-text h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .continue-text p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .continue-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .continue-banner:hover .continue-btn {
            transform: scale(1.1);
        }

        /* Content Sections */
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 48px;
            margin-top: -80px;
            position: relative;
            z-index: 10;
        }

        .page-content {
            padding-top: 100px;
            min-height: 100vh;
        }

        .section {
            margin-bottom: 100px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.021em;
        }

        .see-all {
            color: var(--accent);
            text-decoration: none;
            font-size: 17px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: none;
            border: none;
        }

        .see-all:hover {
            gap: 12px;
            color: var(--text-primary);
        }

        /* Movie Grid */
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 24px;
        }

        .movie-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-secondary);
            aspect-ratio: 2/3;
        }

        .movie-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .movie-card.completed {
            opacity: 0.7;
        }

        .completed-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .movie-card.completed .completed-badge {
            opacity: 1;
        }

        .add-to-list-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            z-index: 15;
        }

        .movie-card:hover .add-to-list-btn {
            opacity: 1;
            transform: scale(1);
        }

        .add-to-list-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        .add-to-list-btn.in-list {
            background: var(--success);
            opacity: 1;
            transform: scale(1);
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.2);
            z-index: 5;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .movie-card:hover img {
            transform: scale(1.1);
        }

        .movie-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, 
                rgba(0,0,0,0.95) 0%, 
                rgba(0,0,0,0.6) 50%,
                transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
        }

        .movie-card:hover .movie-overlay {
            opacity: 1;
        }

        .movie-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .movie-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .movie-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #ffd60a;
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 64px;
            height: 64px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .play-icon svg {
            width: 28px;
            height: 28px;
            margin-left: 4px;
        }

        .movie-card:hover .play-icon {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .remove-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255, 59, 48, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .movie-card:hover .remove-btn {
            opacity: 1;
        }

        /* Featured Grid */
        .featured-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .featured-large {
            grid-row: span 2;
        }

        .featured-card {
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            aspect-ratio: 16/9;
        }

        .featured-card.featured-large {
            aspect-ratio: auto;
            height: 100%;
        }

        .featured-card:hover {
            transform: scale(1.02);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .featured-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .featured-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        .featured-tag {
            display: inline-block;
            padding: 8px 16px;
            background: var(--accent);
            border-radius: 100px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .featured-title {
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.1;
        }

        .featured-card.small .featured-title {
            font-size: 24px;
        }

        .featured-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h2 {
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        /* Filters and Sort */
        .filters-container {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-filter-bar {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-filter-bar input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-filter-bar input:focus {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .search-filter-bar svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .sort-dropdown {
            position: relative;
        }

        .sort-btn {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            background: var(--bg-secondary);
        }

        .sort-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 8px;
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .sort-dropdown.active .sort-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .sort-option {
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sort-option:hover {
            background: var(--bg-tertiary);
        }

        .sort-option.active {
            color: var(--accent);
        }

        .genre-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .genre-chip {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .genre-chip:hover {
            background: var(--bg-secondary);
        }

        .genre-chip.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Search Results Page */
        .search-header {
            margin-bottom: 40px;
        }

        .search-header h2 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .search-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .results-count {
            color: var(--accent);
            font-weight: 600;
        }

        /* Episode Selector */
        .episode-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .episode-modal.active {
            display: flex;
            opacity: 1;
        }

        .episode-container {
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            margin: auto;
            background: var(--bg-secondary);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .episode-header {
            padding: 32px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .episode-show-info h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .episode-show-info p {
            color: var(--text-secondary);
            font-size: 17px;
        }

        .close-episodes {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-episodes:hover {
            background: var(--accent);
            transform: rotate(90deg);
        }

        .episode-content {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .season-sidebar {
            width: 280px;
            border-right: 1px solid var(--glass-border);
            padding: 24px;
            overflow-y: auto;
        }

        .season-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 16px;
            letter-spacing: 0.05em;
        }

        .season-btn {
            width: 100%;
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .season-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .season-btn.active {
            background: var(--accent);
            color: white;
        }

        .episode-list {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .episode-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
        }

        .episode-item:hover {
            background: var(--bg-tertiary);
        }

        .episode-item.watched {
            opacity: 0.5;
        }

        .episode-item.watched::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--success);
            border-radius: 2px;
        }

        .episode-item.current {
            background: rgba(10, 132, 255, 0.15);
            border: 1px solid var(--accent);
        }

        .episode-thumb {
            width: 160px;
            height: 90px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            background: var(--bg-tertiary);
        }

        .episode-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .episode-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .episode-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .episode-number {
            font-size: 14px;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .episode-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .episode-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .episode-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .watched-icon {
            width: 16px;
            height: 16px;
            color: var(--success);
        }

        /* Video Modal */
        .video-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            backdrop-filter: blur(30px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-modal.active {
            display: flex;
            opacity: 1;
        }

        .video-container {
            width: 95%;
            max-width: 1600px;
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            background: #000;
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-controls {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            nav, .hero-content, .content-wrapper { padding-left: 24px; padding-right: 24px; }
            .hero-title { font-size: 56px; }
            .featured-grid { grid-template-columns: 1fr 1fr; }
            .featured-large { grid-row: span 1; }
            .search-suggestions { width: 100%; right: 0; }
            .filters-container { flex-direction: column; align-items: stretch; }
            .search-filter-bar { min-width: 100%; }
        }

        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hero-title { font-size: 40px; }
            .hero { padding-bottom: 100px; }
            .movie-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .featured-grid { grid-template-columns: 1fr; }
            .section-title { font-size: 24px; }
            .episode-content { flex-direction: column; }
            .season-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--glass-border); }
            .search-bar.active { width: 250px; }
            .toast-container { left: 24px; right: 24px; bottom: 24px; }
            .toast { min-width: auto; width: 100%; }
            .genre-filter { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 8px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading CineStream...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- GUI Modal -->
    <div class="gui-modal" id="guiModal">
        <div class="gui-content">
            <div class="gui-icon" id="guiIcon">
                <svg class="icon icon-lg" viewBox="0 0 24 24" style="fill: currentColor;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            </div>
            <h3 class="gui-title" id="guiTitle">Title</h3>
            <p class="gui-message" id="guiMessage">Message</p>
            <div class="gui-buttons" id="guiButtons">
                <button class="gui-btn gui-btn-primary" onclick="closeGuiModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-container" id="navContainer">
        <nav>
            <a class="logo" id="navLogo" onclick="router('home')">CineStream</a>
            <ul class="nav-links">
                <li><a onclick="router('home')" id="nav-home" class="active">Home</a></li>
                <li><a onclick="router('movies')" id="nav-movies">Movies</a></li>
                <li><a onclick="router('tv')" id="nav-tv">TV Shows</a></li>
                <li><a onclick="router('mylist')" id="nav-mylist">My List</a></li>
            </ul>
            <div class="nav-actions">
                <div class="search-container">
                    <div class="search-bar" id="searchBar">
                        <button class="search-btn" onclick="toggleSearch()">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        </button>
                        <input type="text" id="searchInput" placeholder="Search movies, shows..." oninput="handleSearchInput(this.value)" onkeydown="handleSearchKey(event)">
                    </div>
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>
                <div class="user-avatar">CS</div>
            </div>
        </nav>
    </div>

    <!-- HOME PAGE -->
    <div class="page active" id="page-home">
        <section class="hero" id="hero">
            <div class="hero-bg" id="heroBg">
                <img src="" alt="Hero Background">
            </div>
            <div class="hero-gradient"></div>
            <div class="hero-content">
                <div class="hero-badge">
                    <span class="live-dot"></span>
                    Now Streaming
                </div>
                <h1 class="hero-title" id="heroTitle">CineStream</h1>
                <div class="hero-meta" id="heroMeta">
                    <span class="rating">
                        <svg class="icon icon-sm" style="fill: #ffd60a;" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        <span id="heroRating">--</span>
                    </span>
                    <span class="year" id="heroYear">----</span>
                    <span id="heroGenre">Loading...</span>
                    <span>â€¢</span>
                    <span id="heroDuration">--</span>
                </div>
                <p class="hero-description" id="heroDesc">
                    Experience cinema like never before with our premium collection of films and series.
                </p>
                <div class="hero-actions">
                    <button class="btn btn-primary" onclick="playHero()">
                        <svg class="icon" style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        Play Now
                    </button>
                    <button class="btn btn-secondary" onclick="addHeroToList()">
                        <svg class="icon" style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        My List
                    </button>
                </div>
            </div>
        </section>

        <div class="content-wrapper">
            <!-- Continue Watching -->
            <div id="continueWatchingContainer" style="display: none;"></div>

            <!-- Recommended For You -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Recommended For You</h2>
                    <button class="see-all" onclick="refreshRecommendations()">
                        <svg class="icon icon-sm" viewBox="0 0 24 24" style="transform: rotate(0deg); transition: transform 0.3s;" id="refreshIcon"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        Refresh
                    </button>
                </div>
                <div class="movie-grid" id="recommendedGrid"></div>
            </section>

            <!-- New Releases -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">New Releases</h2>
                    <button class="see-all" onclick="router('movies')">See All</button>
                </div>
                <div class="movie-grid" id="newReleasesGrid"></div>
            </section>

            <!-- Featured This Week -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Featured This Week</h2>
                    <button class="see-all" onclick="router('movies')">See All</button>
                </div>
                <div class="featured-grid" id="featuredGrid"></div>
            </section>

            <!-- Trending Now -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Trending Now</h2>
                    <button class="see-all" onclick="router('movies')">See All</button>
                </div>
                <div class="movie-grid" id="trendingGrid"></div>
            </section>

            <!-- Popular Series -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Popular Series</h2>
                    <button class="see-all" onclick="router('tv')">See All</button>
                </div>
                <div class="movie-grid" id="popularGrid"></div>
            </section>

            <!-- Top Rated -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Top Rated</h2>
                    <button class="see-all" onclick="router('movies')">See All</button>
                </div>
                <div class="movie-grid" id="topRatedGrid"></div>
            </section>

            <!-- Because You Watched -->
            <section class="section" id="becauseYouWatchedSection" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title" id="becauseYouWatchedTitle">Because You Watched</h2>
                </div>
                <div class="movie-grid" id="becauseYouWatchedGrid"></div>
            </section>
        </div>
    </div>

    <!-- SEARCH RESULTS PAGE -->
    <div class="page" id="page-search">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="search-header">
                    <h2>Search Results</h2>
                    <p>Found <span class="results-count" id="searchResultsCount">0</span> results for "<span id="searchQueryDisplay"></span>"</p>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="searchResultsInput" placeholder="Refine your search..." oninput="filterSearchResults(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="sortDropdown">
                        <button class="sort-btn" onclick="toggleSortDropdown()">
                            <span id="currentSort">Sort by: Popularity</span>
                            <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortResults('popularity', 'Popularity')">Popularity</div>
                            <div class="sort-option" onclick="sortResults('rating', 'Rating (High to Low)')">Rating (High to Low)</div>
                            <div class="sort-option" onclick="sortResults('date_new', 'Date (Newest)')">Date (Newest)</div>
                            <div class="sort-option" onclick="sortResults('date_old', 'Date (Oldest)')">Date (Oldest)</div>
                            <div class="sort-option" onclick="sortResults('title_az', 'Title (A-Z)')">Title (A-Z)</div>
                            <div class="sort-option" onclick="sortResults('title_za', 'Title (Z-A)')">Title (Z-A)</div>
                        </div>
                    </div>
                </div>

                <div class="genre-filter" id="searchGenreFilter">
                    <div class="genre-chip active" onclick="filterByGenre('all')">All</div>
                    <div class="genre-chip" onclick="filterByGenre(28)">Action</div>
                    <div class="genre-chip" onclick="filterByGenre(35)">Comedy</div>
                    <div class="genre-chip" onclick="filterByGenre(18)">Drama</div>
                    <div class="genre-chip" onclick="filterByGenre(27)">Horror</div>
                    <div class="genre-chip" onclick="filterByGenre(10749)">Romance</div>
                    <div class="genre-chip" onclick="filterByGenre(878)">Sci-Fi</div>
                    <div class="genre-chip" onclick="filterByGenre(53)">Thriller</div>
                </div>

                <div class="movie-grid" id="searchResultsGrid"></div>
                
                <div id="noSearchResults" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <h2>No results found</h2>
                    <p>Try adjusting your search or filters</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MOVIES PAGE -->
    <div class="page" id="page-movies">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 32px;">
                    <h2 class="section-title">All Movies</h2>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="moviesSearchInput" placeholder="Search movies..." oninput="filterMovies(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="moviesSortDropdown">
                        <button class="sort-btn" onclick="toggleMoviesSort()">
                            <span>Sort by: Latest</span>
                            <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortMovies('latest')">Latest</div>
                            <div class="sort-option" onclick="sortMovies('rating')">Highest Rated</div>
                            <div class="sort-option" onclick="sortMovies('popular')">Most Popular</div>
                            <div class="sort-option" onclick="sortMovies('title_az')">A-Z</div>
                        </div>
                    </div>
                </div>

                <div class="movie-grid" id="allMoviesGrid"></div>
            </div>
        </div>
    </div>

    <!-- TV SHOWS PAGE -->
    <div class="page" id="page-tv">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 32px;">
                    <h2 class="section-title">TV Shows</h2>
                </div>
                
                <div class="filters-container">
                    <div class="search-filter-bar">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="tvSearchInput" placeholder="Search TV shows..." oninput="filterTV(this.value)">
                    </div>
                    
                    <div class="sort-dropdown" id="tvSortDropdown">
                        <button class="sort-btn" onclick="toggleTVSort()">
                            <span>Sort by: Latest</span>
                            <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                        </button>
                        <div class="sort-menu">
                            <div class="sort-option active" onclick="sortTV('latest')">Latest</div>
                            <div class="sort-option" onclick="sortTV('rating')">Highest Rated</div>
                            <div class="sort-option" onclick="sortTV('popular')">Most Popular</div>
                            <div class="sort-option" onclick="sortTV('title_az')">A-Z</div>
                        </div>
                    </div>
                </div>

                <div class="movie-grid" id="allTVGrid"></div>
            </div>
        </div>
    </div>

    <!-- MY LIST PAGE -->
    <div class="page" id="page-mylist">
        <div class="page-content">
            <div class="content-wrapper">
                <div class="section-header" style="margin-bottom: 40px;">
                    <h2 class="section-title">My List</h2>
                    <button class="see-all btn-danger" onclick="clearMyList()">Clear All</button>
                </div>
                
                <div id="myListGrid" class="movie-grid"></div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    <h2>Your list is empty</h2>
                    <p>Movies and shows you add will appear here</p>
                    <button class="btn btn-primary" onclick="router('home')" style="margin-top: 24px;">Browse Content</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-container">
            <div class="video-controls">
                <button class="control-btn" onclick="toggleEpisodeSelector()" title="Episodes" id="episodesBtn" style="display: none;">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z"/></svg>
                </button>
                <button class="control-btn" onclick="closeVideo()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="video-wrapper" id="videoWrapper"></div>
        </div>
    </div>

    <!-- Episode Selector Modal -->
    <div class="episode-modal" id="episodeModal">
        <div class="episode-container">
            <div class="episode-header">
                <div class="episode-show-info">
                    <h2 id="episodeShowTitle">Show Title</h2>
                    <p id="episodeShowMeta">Select an episode to watch</p>
                </div>
                <button class="close-episodes" onclick="closeEpisodeSelector()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="episode-content">
                <div class="season-sidebar" id="seasonList"></div>
                <div class="episode-list" id="episodeList"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const TMDB_API_KEY = '593f936ea6ac7068502a786d74859854';
        const TMDB_READ_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI1OTNmOTM2ZWE2YWM3MDY4NTAyYTc4NmQ3NDg1OTg1NCIsIm5iZiI6MTczMTMzMTU4Mi44MTMsInN1YiI6IjY3MzIwNWZlNjE2MjZhYzEwNmJlNzJjMiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hgVwkcWxSn9jSmUcTvYMp6a3jPXrkvv5v_W0ONR2nmk';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_BASE = 'https://image.tmdb.org/t/p/original';
        const IMG_POSTER = 'https://image.tmdb.org/t/p/w500';
        const IMG_STILL = 'https://image.tmdb.org/t/p/w300';

        // State
        let currentHeroId = null;
        let currentHeroType = 'movie';
        let currentTVId = null;
        let currentSeason = 1;
        let currentEpisode = 1;
        let currentVideoType = 'movie';
        let currentVideoId = null;
        let watchedEpisodes = JSON.parse(localStorage.getItem('watchedEpisodes') || '{}');
        let continueWatching = JSON.parse(localStorage.getItem('continueWatching') || '[]');
        let myList = JSON.parse(localStorage.getItem('myList') || '[]');
        let searchTimeout = null;
        let currentSearchResults = [];
        let currentSearchQuery = '';
        let currentGenreFilter = 'all';

        // Cache for API data
        const cache = {
            movies: [],
            tv: [],
            hero: null,
            recommended: [],
            newReleases: [],
            topRated: [],
            trending: []
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            setupNavigation();
            
            // Try to fetch from API
            const success = await fetchAllData();
            
            if (!success) {
                showToast('Using offline mode', 'warning');
            }
            
            // Check URL hash for routing
            const hash = window.location.hash.replace('#', '') || 'home';
            router(hash, false);
            
            // Update continue watching
            updateContinueWatching();
            
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 500);
        }

        function setupNavigation() {
            window.addEventListener('scroll', () => {
                document.getElementById('navContainer').classList.toggle('scrolled', window.scrollY > 50);
            });
            
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.replace('#', '') || 'home';
                showPage(hash);
            });

            // Close search when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    closeSearch();
                }
                if (!e.target.closest('.sort-dropdown')) {
                    closeAllSortDropdowns();
                }
            });
        }

        // Toast Notifications
        function showToast(message, type = 'success', title = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '<svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
                error: '<svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',
                warning: '<svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>'
            };

            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Notice'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // GUI Modal (replaces alerts)
        function showGuiModal(options) {
            const modal = document.getElementById('guiModal');
            const icon = document.getElementById('guiIcon');
            const title = document.getElementById('guiTitle');
            const message = document.getElementById('guiMessage');
            const buttons = document.getElementById('guiButtons');

            icon.className = `gui-icon ${options.type || 'confirm'}`;
            
            const icons = {
                success: '<svg class="icon icon-lg" viewBox="0 0 24 24" style="fill: currentColor;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
                error: '<svg class="icon icon-lg" viewBox="0 0 24 24" style="fill: currentColor;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',
                warning: '<svg class="icon icon-lg" viewBox="0 0 24 24" style="fill: currentColor;"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
                confirm: '<svg class="icon icon-lg" viewBox="0 0 24 24" style="fill: currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'
            };

            icon.innerHTML = icons[options.type || 'confirm'];
            title.textContent = options.title || 'Confirm';
            message.textContent = options.message || '';

            buttons.innerHTML = '';
            
            if (options.buttons) {
                options.buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = `gui-btn ${btn.primary ? 'gui-btn-primary' : 'gui-btn-secondary'}`;
                    button.textContent = btn.text;
                    button.onclick = () => {
                        closeGuiModal();
                        if (btn.onClick) btn.onClick();
                    };
                    buttons.appendChild(button);
                });
            } else {
                buttons.innerHTML = '<button class="gui-btn gui-btn-primary" onclick="closeGuiModal()">OK</button>';
            }

            modal.classList.add('active');
        }

        function closeGuiModal() {
            document.getElementById('guiModal').classList.remove('active');
        }

        // API Functions
        async function fetchTMDB(endpoint, params = '') {
            try {
                const url = `${BASE_URL}${endpoint}?api_key=${TMDB_API_KEY}&language=en-US${params}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${TMDB_READ_TOKEN}`
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('TMDB Error:', error);
                return null;
            }
        }

        async function fetchAllData() {
            try {
                document.getElementById('loadingText').textContent = 'Fetching movies...';
                const movies = await fetchTMDB('/movie/popular', '&page=1');
                if (movies?.results) cache.movies = movies.results;

                document.getElementById('loadingText').textContent = 'Fetching TV shows...';
                const tv = await fetchTMDB('/tv/popular', '&page=1');
                if (tv?.results) cache.tv = tv.results;

                document.getElementById('loadingText').textContent = 'Fetching trending...';
                const trending = await fetchTMDB('/trending/movie/week');
                if (trending?.results) cache.trending = trending.results;

                document.getElementById('loadingText').textContent = 'Fetching new releases...';
                const newReleases = await fetchTMDB('/movie/now_playing');
                if (newReleases?.results) cache.newReleases = newReleases.results;

                document.getElementById('loadingText').textContent = 'Fetching top rated...';
                const topRated = await fetchTMDB('/movie/top_rated');
                if (topRated?.results) cache.topRated = topRated.results;

                document.getElementById('loadingText').textContent = 'Fetching recommendations...';
                await fetchRecommendations();

                // Load hero from trending
                if (trending?.results?.length > 0) {
                    const heroMovie = trending.results[Math.floor(Math.random() * Math.min(5, trending.results.length))];
                    const details = await fetchTMDB(`/movie/${heroMovie.id}`);
                    if (details) {
                        cache.hero = details;
                        loadHero(details);
                    }
                }

                // Load all sections
                loadHomeSections();

                return true;
            } catch (error) {
                console.error('Failed to fetch data:', error);
                return false;
            }
        }

        async function fetchRecommendations() {
            // Get random movies for recommendations
            const randomPage = Math.floor(Math.random() * 5) + 1;
            const recs = await fetchTMDB('/discover/movie', `&sort_by=popularity.desc&page=${randomPage}`);
            if (recs?.results) {
                cache.recommended = shuffleArray(recs.results).slice(0, 6);
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Load Hero
        function loadHero(movie) {
            currentHeroId = movie.id;
            currentHeroType = 'movie';
            
            document.getElementById('heroTitle').textContent = movie.title;
            document.getElementById('heroRating').textContent = movie.vote_average?.toFixed(1) || '--';
            document.getElementById('heroYear').textContent = movie.release_date?.split('-')[0] || '----';
            document.getElementById('heroDesc').textContent = movie.overview || 'No description available.';
            document.getElementById('heroBg').querySelector('img').src = IMG_BASE + (movie.backdrop_path || movie.poster_path);
            
            if (movie.runtime) {
                const hours = Math.floor(movie.runtime / 60);
                const mins = movie.runtime % 60;
                document.getElementById('heroDuration').textContent = `${hours}h ${mins}m`;
            } else {
                document.getElementById('heroDuration').textContent = '--';
            }

            if (movie.genres?.length > 0) {
                document.getElementById('heroGenre').textContent = movie.genres[0].name;
            } else {
                document.getElementById('heroGenre').textContent = 'Movie';
            }
        }

        // Load Home Sections
        function loadHomeSections() {
            // Recommended (randomized)
            document.getElementById('recommendedGrid').innerHTML = cache.recommended.map(m => createMovieCard(m, 'movie')).join('');

            // New Releases
            document.getElementById('newReleasesGrid').innerHTML = cache.newReleases.slice(0, 6).map(m => createMovieCard(m, 'movie')).join('');

            // Featured
            const featured = [
                ...cache.movies.slice(0, 3).map(m => ({...m, type: 'movie'})),
                ...cache.tv.slice(0, 2).map(t => ({...t, title: t.name, type: 'tv'}))
            ];
            document.getElementById('featuredGrid').innerHTML = featured.map((item, i) => {
                const isLarge = i === 0;
                return `
                    <div class="featured-card ${isLarge ? 'featured-large' : 'small'}" onclick="handleContentClick(${item.id}, '${item.type}')">
                        <img src="${IMG_BASE}${item.backdrop_path || item.poster_path}" alt="${item.title}" loading="lazy">
                        <div class="featured-content">
                            ${isLarge ? '<span class="featured-tag">Featured</span>' : ''}
                            <h3 class="featured-title">${item.title}</h3>
                            <div class="featured-meta">
                                <span style="color: #ffd60a;">â˜… ${item.vote_average?.toFixed(1) || '--'}</span>
                                <span>${item.type === 'movie' ? 'Movie' : 'Series'}</span>
                                <span>â€¢</span>
                                <span>${item.type === 'movie' ? (item.release_date?.split('-')[0] || '----') : (item.first_air_date?.split('-')[0] || '----')}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Trending
            document.getElementById('trendingGrid').innerHTML = cache.trending.slice(0, 6).map(m => createMovieCard(m, 'movie')).join('');

            // Popular TV
            document.getElementById('popularGrid').innerHTML = cache.tv.slice(0, 6).map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');

            // Top Rated
            document.getElementById('topRatedGrid').innerHTML = cache.topRated.slice(0, 6).map(m => createMovieCard(m, 'movie')).join('');

            // Because You Watched (if has history)
            updateBecauseYouWatched();
        }

        async function refreshRecommendations() {
            const icon = document.getElementById('refreshIcon');
            icon.style.transform = 'rotate(360deg)';
            
            await fetchRecommendations();
            document.getElementById('recommendedGrid').innerHTML = cache.recommended.map(m => createMovieCard(m, 'movie')).join('');
            
            setTimeout(() => {
                icon.style.transform = 'rotate(0deg)';
            }, 300);
            
            showToast('Recommendations updated', 'success');
        }

        function updateBecauseYouWatched() {
            const section = document.getElementById('becauseYouWatchedSection');
            const grid = document.getElementById('becauseYouWatchedGrid');
            const title = document.getElementById('becauseYouWatchedTitle');
            
            if (continueWatching.length === 0) {
                section.style.display = 'none';
                return;
            }

            const lastWatched = continueWatching[continueWatching.length - 1];
            const item = lastWatched.type === 'movie' 
                ? cache.movies.find(m => m.id === lastWatched.id)
                : cache.tv.find(t => t.id === lastWatched.id);

            if (!item) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            title.textContent = `Because You Watched ${item.title || item.name}`;
            
            // Get similar content
            const similar = lastWatched.type === 'movie'
                ? cache.movies.filter(m => m.id !== item.id).slice(0, 6)
                : cache.tv.filter(t => t.id !== item.id).slice(0, 6);
            
            grid.innerHTML = similar.map(i => createMovieCard({...i, title: i.title || i.name}, lastWatched.type)).join('');
        }

        // Create Movie Card with Add to List button
        function createMovieCard(item, type) {
            const year = type === 'movie' ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0];
            const totalEpisodes = type === 'tv' ? item.number_of_episodes : 1;
            const isCompleted = type === 'tv' ? isSeriesCompleted(item.id, totalEpisodes) : false;
            const progress = getProgress(item.id, type);
            const inList = myList.some(i => i.id === item.id && i.type === type);
            
            return `
                <div class="movie-card ${isCompleted ? 'completed' : ''}" data-id="${item.id}" data-type="${type}">
                    <button class="add-to-list-btn ${inList ? 'in-list' : ''}" onclick="toggleListFromCard(${item.id}, '${type}', event)" title="${inList ? 'In List' : 'Add to List'}">
                        <svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24">
                            ${inList 
                                ? '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>' 
                                : '<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>'
                            }
                        </svg>
                    </button>
                    ${isCompleted ? `
                        <div class="completed-badge">
                            <svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </div>
                    ` : ''}
                    <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1c1c1e/98989d?text=${encodeURIComponent(item.title)}'">
                    ${progress > 0 && progress < 100 ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    ` : ''}
                    <div class="play-icon">
                        <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <div class="movie-overlay" onclick="handleContentClick(${item.id}, '${type}')">
                        <div class="movie-title">${item.title}</div>
                        <div class="movie-meta">
                            <span class="movie-rating">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                ${item.vote_average?.toFixed(1) || '--'}
                            </span>
                            <span>${year || '----'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle list from card
        function toggleListFromCard(id, type, event) {
            event.stopPropagation();
            const item = type === 'movie'
                ? cache.movies.find(m => m.id === id)
                : cache.tv.find(t => t.id === id);
            
            if (!item) return;
            
            const listItem = {
                id: item.id,
                title: item.title || item.name,
                poster_path: item.poster_path,
                rating: item.vote_average?.toFixed(1),
                year: type === 'movie' ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0],
                type: type
            };
            
            const existingIndex = myList.findIndex(i => i.id === id && i.type === type);
            
            if (existingIndex > -1) {
                myList.splice(existingIndex, 1);
                showToast('Removed from My List', 'success');
            } else {
                myList.push(listItem);
                showToast('Added to My List', 'success');
            }
            
            localStorage.setItem('myList', JSON.stringify(myList));
            
            // Update button appearance
            const btn = event.currentTarget;
            const inList = existingIndex === -1;
            btn.classList.toggle('in-list', inList);
            btn.innerHTML = `
                <svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24">
                    ${inList 
                        ? '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>' 
                        : '<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>'
                    }
                </svg>
            `;
            btn.title = inList ? 'In List' : 'Add to List';
        }

        // Progress Tracking
        function getProgress(id, type) {
            if (type === 'movie') {
                const watched = watchedEpisodes[`movie-${id}`];
                return watched ? 100 : 0;
            } else {
                const show = cache.tv.find(t => t.id === id);
                if (!show) return 0;
                const watched = watchedEpisodes[id] || {};
                const watchedCount = Object.keys(watched).length;
                return (watchedCount / show.number_of_episodes) * 100;
            }
        }

        function isSeriesCompleted(id, totalEpisodes) {
            const watched = watchedEpisodes[id] || {};
            return Object.keys(watched).length >= totalEpisodes;
        }

        // Continue Watching
        function updateContinueWatching() {
            const container = document.getElementById('continueWatchingContainer');
            if (!continueWatching.length) {
                container.style.display = 'none';
                return;
            }

            const latest = continueWatching[continueWatching.length - 1];
            const item = latest.type === 'movie' 
                ? cache.movies.find(m => m.id === latest.id)
                : cache.tv.find(t => t.id === latest.id);

            if (!item) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = `
                <div class="continue-banner" onclick="resumeWatching(${latest.id}, '${latest.type}')">
                    <div class="continue-info">
                        <div class="continue-thumb">
                            <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title || item.name}">
                        </div>
                        <div class="continue-text">
                            <h3>Continue Watching</h3>
                            <p>${item.title || item.name} ${latest.episode ? `- S${latest.season}E${latest.episode}` : ''}</p>
                        </div>
                    </div>
                    <button class="continue-btn">
                        <svg class="icon" viewBox="0 0 24 24" style="fill: white;"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                </div>
            `;
        }

        function resumeWatching(id, type) {
            const item = continueWatching.find(c => c.id === id && c.type === type);
            if (!item) return;

            if (type === 'tv' && item.season && item.episode) {
                const url = `https://vidfast.pro/tv/${id}/${item.season}/${item.episode}?autoPlay=true`;
                playContent(url, 'tv', id, item.season, item.episode);
            } else {
                handleContentClick(id, type);
            }
        }

        // Search Functionality
        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.classList.toggle('active');
            if (searchBar.classList.contains('active')) {
                searchBar.querySelector('input').focus();
            }
        }

        function closeSearch() {
            document.getElementById('searchBar').classList.remove('active');
            document.getElementById('searchSuggestions').classList.remove('active');
        }

        function handleSearchInput(query) {
            if (!query.trim()) {
                document.getElementById('searchSuggestions').classList.remove('active');
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const results = await fetchTMDB('/search/multi', `&query=${encodeURIComponent(query)}&page=1`);
                
                if (results?.results) {
                    showSearchSuggestions(results.results.slice(0, 5));
                }
            }, 300);
        }

        function handleSearchKey(e) {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if (query) {
                    closeSearch();
                    performSearch(query);
                }
            }
        }

        function showSearchSuggestions(results) {
            const container = document.getElementById('searchSuggestions');
            
            container.innerHTML = results.map(item => {
                const isMovie = item.media_type === 'movie';
                const title = isMovie ? item.title : item.name;
                const year = isMovie ? item.release_date?.split('-')[0] : item.first_air_date?.split('-')[0];
                
                return `
                    <div class="suggestion-item" onclick="selectSearchResult(${item.id}, '${item.media_type}')">
                        <div class="suggestion-thumb">
                            <img src="${item.poster_path ? IMG_POSTER + item.poster_path : 'https://via.placeholder.com/50x75/1c1c1e/98989d?text=?'}" alt="${title}">
                        </div>
                        <div class="suggestion-info">
                            <div class="suggestion-title">${title}</div>
                            <div class="suggestion-meta">${year || '----'} â€¢ ${isMovie ? 'Movie' : 'TV Series'}</div>
                        </div>
                        <span class="suggestion-type">${isMovie ? 'Movie' : 'TV'}</span>
                    </div>
                `;
            }).join('');

            container.classList.add('active');
        }

        async function performSearch(query) {
            currentSearchQuery = query;
            document.getElementById('searchQueryDisplay').textContent = query;
            
            const results = await fetchTMDB('/search/multi', `&query=${encodeURIComponent(query)}&page=1`);
            
            if (results?.results) {
                currentSearchResults = results.results.filter(r => r.media_type === 'movie' || r.media_type === 'tv');
                document.getElementById('searchResultsCount').textContent = currentSearchResults.length;
                displaySearchResults(currentSearchResults);
            }
            
            router('search');
        }

        function displaySearchResults(results) {
            const grid = document.getElementById('searchResultsGrid');
            const noResults = document.getElementById('noSearchResults');
            
            if (results.length === 0) {
                grid.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            grid.innerHTML = results.map(item => {
                const type = item.media_type;
                const displayItem = {...item, title: item.title || item.name};
                return createMovieCard(displayItem, type);
            }).join('');
        }

        function filterSearchResults(query) {
            if (!query) {
                displaySearchResults(currentSearchResults);
                return;
            }
            
            const filtered = currentSearchResults.filter(item => {
                const title = (item.title || item.name).toLowerCase();
                return title.includes(query.toLowerCase());
            });
            
            displaySearchResults(filtered);
        }

        function selectSearchResult(id, type) {
            closeSearch();
            handleContentClick(id, type === 'movie' ? 'movie' : 'tv');
        }

        // Sort and Filter
        function toggleSortDropdown() {
            document.getElementById('sortDropdown').classList.toggle('active');
        }

        function toggleMoviesSort() {
            document.getElementById('moviesSortDropdown').classList.toggle('active');
        }

        function toggleTVSort() {
            document.getElementById('tvSortDropdown').classList.toggle('active');
        }

        function closeAllSortDropdowns() {
            document.querySelectorAll('.sort-dropdown').forEach(d => d.classList.remove('active'));
        }

        function sortResults(criteria, label) {
            document.getElementById('currentSort').textContent = `Sort by: ${label}`;
            document.querySelectorAll('#sortDropdown .sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            let sorted = [...currentSearchResults];
            
            switch(criteria) {
                case 'rating':
                    sorted.sort((a, b) => b.vote_average - a.vote_average);
                    break;
                case 'date_new':
                    sorted.sort((a, b) => new Date(b.release_date || b.first_air_date) - new Date(a.release_date || a.first_air_date));
                    break;
                case 'date_old':
                    sorted.sort((a, b) => new Date(a.release_date || a.first_air_date) - new Date(b.release_date || b.first_air_date));
                    break;
                case 'title_az':
                    sorted.sort((a, b) => (a.title || a.name).localeCompare(b.title || b.name));
                    break;
                case 'title_za':
                    sorted.sort((a, b) => (b.title || b.name).localeCompare(a.title || a.name));
                    break;
                default:
                    // popularity - default order
                    break;
            }
            
            displaySearchResults(sorted);
        }

        function filterByGenre(genreId) {
            currentGenreFilter = genreId;
            
            document.querySelectorAll('#searchGenreFilter .genre-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (genreId === 'all') {
                displaySearchResults(currentSearchResults);
                return;
            }
            
            const filtered = currentSearchResults.filter(item => {
                return item.genre_ids && item.genre_ids.includes(parseInt(genreId));
            });
            
            displaySearchResults(filtered);
        }

        // Movies and TV filtering
        function filterMovies(query) {
            const grid = document.getElementById('allMoviesGrid');
            if (!query) {
                grid.innerHTML = cache.movies.map(m => createMovieCard(m, 'movie')).join('');
                return;
            }
            
            const filtered = cache.movies.filter(m => m.title.toLowerCase().includes(query.toLowerCase()));
            grid.innerHTML = filtered.map(m => createMovieCard(m, 'movie')).join('');
        }

        function filterTV(query) {
            const grid = document.getElementById('allTVGrid');
            if (!query) {
                grid.innerHTML = cache.tv.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
                return;
            }
            
            const filtered = cache.tv.filter(t => t.name.toLowerCase().includes(query.toLowerCase()));
            grid.innerHTML = filtered.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
        }

        function sortMovies(criteria) {
            event.target.parentElement.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            let sorted = [...cache.movies];
            
            switch(criteria) {
                case 'rating':
                    sorted.sort((a, b) => b.vote_average - a.vote_average);
                    break;
                case 'popular':
                    sorted.sort((a, b) => b.popularity - a.popularity);
                    break;
                case 'title_az':
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                default: // latest
                    sorted.sort((a, b) => new Date(b.release_date) - new Date(a.release_date));
            }
            
            document.getElementById('allMoviesGrid').innerHTML = sorted.map(m => createMovieCard(m, 'movie')).join('');
        }

        function sortTV(criteria) {
            event.target.parentElement.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            closeAllSortDropdowns();
            
            let sorted = [...cache.tv];
            
            switch(criteria) {
                case 'rating':
                    sorted.sort((a, b) => b.vote_average - a.vote_average);
                    break;
                case 'popular':
                    sorted.sort((a, b) => b.popularity - a.popularity);
                    break;
                case 'title_az':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                default: // latest
                    sorted.sort((a, b) => new Date(b.first_air_date) - new Date(a.first_air_date));
            }
            
            document.getElementById('allTVGrid').innerHTML = sorted.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
        }

        // Content Click Handler
        async function handleContentClick(id, type) {
            currentVideoType = type;
            currentVideoId = id;

            if (type === 'tv') {
                currentTVId = id;
                let show = cache.tv.find(t => t.id === id);
                if (!show) {
                    show = await fetchTMDB(`/tv/${id}`);
                    if (show) cache.tv.push(show);
                }
                
                if (show) {
                    // Check if user has progress
                    const progress = getWatchingProgress(id);
                    if (progress) {
                        showGuiModal({
                            type: 'confirm',
                            title: 'Resume Watching?',
                            message: `Continue from S${progress.season}E${progress.episode} - ${progress.episodeName}?`,
                            buttons: [
                                { text: 'Resume', primary: true, onClick: () => {
                                    playEpisode(progress.season, progress.episode, progress.episodeName, false);
                                }},
                                { text: 'Start Over', primary: false, onClick: () => {
                                    openEpisodeSelector(show);
                                }}
                            ]
                        });
                        return;
                    }
                    openEpisodeSelector(show);
                }
            } else {
                playContent(`https://vidfast.pro/movie/${id}`, 'movie', id);
            }
        }

        function getWatchingProgress(id) {
            const entry = continueWatching.find(c => c.id === id && c.type === 'tv');
            return entry || null;
        }

        // Episode Selector
        async function openEpisodeSelector(show) {
            currentTVId = show.id;
            document.getElementById('episodeShowTitle').textContent = show.name;
            document.getElementById('episodeShowMeta').textContent = `${show.number_of_seasons} Seasons â€¢ ${show.number_of_episodes} Episodes`;

            const seasonsData = await fetchTMDB(`/tv/${show.id}`);
            const seasons = seasonsData?.seasons?.filter(s => s.season_number > 0) || [];

            document.getElementById('seasonList').innerHTML = `
                <div class="season-title">Seasons</div>
                ${seasons.map(s => `
                    <button class="season-btn ${s.season_number === currentSeason ? 'active' : ''}" onclick="switchSeason(${s.season_number})">
                        <span>Season ${s.season_number}</span>
                        <span style="color: var(--text-secondary); font-size: 14px;">${s.episode_count} ep</span>
                    </button>
                `).join('')}
            `;

            document.getElementById('episodeModal').classList.add('active');
            await loadEpisodes(currentSeason, show.id);
        }

        async function switchSeason(seasonNum) {
            currentSeason = seasonNum;
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(`Season ${seasonNum}`));
            });
            await loadEpisodes(seasonNum, currentTVId);
        }

        async function loadEpisodes(seasonNum, showId) {
            const data = await fetchTMDB(`/tv/${showId}/season/${seasonNum}`);
            if (!data?.episodes) return;

            const showWatched = watchedEpisodes[showId] || {};
            const continueItem = continueWatching.find(c => c.id === showId && c.type === 'tv');

            document.getElementById('episodeList').innerHTML = data.episodes.map(ep => {
                const epKey = `${seasonNum}-${ep.episode_number}`;
                const isWatched = showWatched[epKey];
                const isCurrent = continueItem && continueItem.season === seasonNum && continueItem.episode === ep.episode_number;

                return `
                    <div class="episode-item ${isWatched ? 'watched' : ''} ${isCurrent ? 'current' : ''}" onclick="playEpisode(${seasonNum}, ${ep.episode_number}, '${ep.name.replace(/'/g, "\\'")}', true)">
                        <div class="episode-thumb">
                            <img src="${ep.still_path ? IMG_STILL + ep.still_path : 'https://via.placeholder.com/160x90/1c1c1e/98989d?text=Ep+' + ep.episode_number}" alt="${ep.name}">
                            <span class="episode-duration">${ep.runtime || 45}m</span>
                        </div>
                        <div class="episode-info">
                            <div class="episode-number">Episode ${ep.episode_number}</div>
                            <div class="episode-name">${ep.name}</div>
                            <div class="episode-desc">${ep.overview || 'No description available.'}</div>
                            ${isWatched ? `
                                <div class="episode-status">
                                    <svg class="watched-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                    Watched
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function playEpisode(season, episode, episodeName, saveProgress = true) {
            currentSeason = season;
            currentEpisode = episode;

            if (saveProgress) {
                if (!watchedEpisodes[currentTVId]) watchedEpisodes[currentTVId] = {};
                watchedEpisodes[currentTVId][`${season}-${episode}`] = true;
                localStorage.setItem('watchedEpisodes', JSON.stringify(watchedEpisodes));

                const existingIndex = continueWatching.findIndex(c => c.id === currentTVId && c.type === 'tv');
                const newEntry = {
                    id: currentTVId,
                    type: 'tv',
                    season: season,
                    episode: episode,
                    episodeName: episodeName,
                    timestamp: Date.now()
                };

                if (existingIndex > -1) {
                    continueWatching[existingIndex] = newEntry;
                } else {
                    continueWatching.push(newEntry);
                }
                
                if (continueWatching.length > 10) {
                    continueWatching = continueWatching.slice(-10);
                }
                
                localStorage.setItem('continueWatching', JSON.stringify(continueWatching));
                updateContinueWatching();
                updateBecauseYouWatched();

                // Check if series completed
                const show = cache.tv.find(t => t.id === currentTVId);
                if (show && isSeriesCompleted(currentTVId, show.number_of_episodes)) {
                    showToast(`You've completed ${show.name}!`, 'success');
                }
            }

            await loadEpisodes(season, currentTVId);

            const url = `https://vidfast.pro/tv/${currentTVId}/${season}/${episode}?autoPlay=true`;
            closeEpisodeSelector();
            playContent(url, 'tv', currentTVId, season, episode);
        }

        function closeEpisodeSelector() {
            document.getElementById('episodeModal').classList.remove('active');
        }

        // Video Player
        function playContent(url, type, id, season = null, episode = null) {
            currentVideoType = type;
            currentVideoId = id;

            document.getElementById('videoWrapper').innerHTML = `
                <iframe src="${url}" frameborder="0" allowfullscreen allow="encrypted-media; autoplay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
            `;

            document.getElementById('episodesBtn').style.display = type === 'tv' ? 'flex' : 'none';
            document.getElementById('videoModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function playHero() {
            if (!currentHeroId) return;
            handleContentClick(currentHeroId, currentHeroType);
        }

        function closeVideo() {
            document.getElementById('videoWrapper').innerHTML = '';
            document.getElementById('videoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleEpisodeSelector() {
            if (currentVideoType === 'tv' && currentTVId) {
                const show = cache.tv.find(t => t.id === currentTVId);
                if (show) openEpisodeSelector(show);
            }
        }

        // My List Functions
        function addHeroToList() {
            if (!cache.hero) return;
            
            const item = {
                id: cache.hero.id,
                title: cache.hero.title,
                poster_path: cache.hero.poster_path,
                rating: cache.hero.vote_average?.toFixed(1),
                year: cache.hero.release_date?.split('-')[0],
                type: 'movie'
            };
            
            addToMyList(item);
        }

        function addToMyList(item) {
            if (myList.some(i => i.id === item.id && i.type === item.type)) {
                showToast('Already in your list', 'warning');
                return;
            }

            myList.push(item);
            localStorage.setItem('myList', JSON.stringify(myList));
            showToast('Added to My List', 'success');
        }

        function removeFromList(id, event) {
            event.stopPropagation();
            myList = myList.filter(item => item.id !== id);
            localStorage.setItem('myList', JSON.stringify(myList));
            loadMyList();
            showToast('Removed from My List', 'success');
        }

        function clearMyList() {
            if (!myList.length) return;
            
            showGuiModal({
                type: 'confirm',
                title: 'Clear List?',
                message: 'Are you sure you want to remove all items from your list?',
                buttons: [
                    { text: 'Clear', primary: true, onClick: () => {
                        myList = [];
                        localStorage.setItem('myList', JSON.stringify(myList));
                        loadMyList();
                        showToast('List cleared', 'success');
                    }},
                    { text: 'Cancel', primary: false, onClick: () => {} }
                ]
            });
        }

        function loadMyList() {
            const grid = document.getElementById('myListGrid');
            const emptyState = document.getElementById('emptyState');

            if (!myList.length) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = myList.map(item => `
                <div class="movie-card" data-id="${item.id}">
                    <button class="remove-btn" onclick="removeFromList(${item.id}, event)" title="Remove">
                        <svg class="icon icon-sm" style="fill: white;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                    <img src="${IMG_POSTER}${item.poster_path}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1c1c1e/98989d?text=${encodeURIComponent(item.title)}'">
                    <div class="play-icon" onclick="playItem(${item.id}, '${item.type}')">
                        <svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <div class="movie-overlay">
                        <div class="movie-title">${item.title}</div>
                        <div class="movie-meta">
                            <span class="movie-rating">
                                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                ${item.rating}
                            </span>
                            <span>${item.year}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function playItem(id, type) {
            handleContentClick(id, type);
        }

        // Router
        function router(route, updateHash = true) {
            if (updateHash) {
                window.location.hash = route;
            }
            showPage(route);
        }

        function showPage(route) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            const pageId = `page-${route}`;
            const page = document.getElementById(pageId);
            
            if (page) {
                page.classList.add('active');
            } else {
                document.getElementById('page-home').classList.add('active');
                route = 'home';
            }

            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const navLink = document.getElementById(`nav-${route}`);
            if (navLink) navLink.classList.add('active');

            const logo = document.getElementById('navLogo');
            if (route === 'home') {
                logo.classList.remove('hidden');
            } else {
                logo.classList.add('hidden');
            }

            window.scrollTo(0, 0);

            if (route === 'mylist') loadMyList();
            if (route === 'movies') {
                document.getElementById('allMoviesGrid').innerHTML = cache.movies.map(m => createMovieCard(m, 'movie')).join('');
            }
            if (route === 'tv') {
                document.getElementById('allTVGrid').innerHTML = cache.tv.map(t => createMovieCard({...t, title: t.name}, 'tv')).join('');
            }
        }

        // Close modals on background click
        document.getElementById('videoModal').addEventListener('click', (e) => {
            if (e.target.id === 'videoModal') closeVideo();
        });

        document.getElementById('episodeModal').addEventListener('click', (e) => {
            if (e.target.id === 'episodeModal') closeEpisodeSelector();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('guiModal').classList.contains('active')) {
                    closeGuiModal();
                } else if (document.getElementById('episodeModal').classList.contains('active')) {
                    closeEpisodeSelector();
                } else {
                    closeVideo();
                }
            }
        });
    </script>

</body>
</html>
